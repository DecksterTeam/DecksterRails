photo_docs = undefined
max_i = undefined
i = undefined
summary_image_tag_loader = undefined
summary_image_div_tag = undefined

get_thumb_url = () ->
    photo_docs[i]['thumb_url']

get_next = () ->
    i = 0 if i > max_i
    summary_image_tag_loader.attr 'src', get_thumb_url()

success_get_next = () ->
    i++
    get_next()

error_get_next = () ->
    photo_docs.splice i, 1
    max_i--
    get_next() unless max_i < 0

summary_init = (_photo_docs) ->
    photo_docs = _photo_docs
    max_i = _photo_docs.length - 1
    i = 0

    summary_image_div_tag = $('.this_photo')
    summary_image_tag_loader = $('.deckster_photos_summary_photo_loader')

    summary_image_tag_loader.load () ->
        summary_image_div_tag.fadeOut 350, () =>
            summary_image_div_tag.css 'background-image', 'url(' + get_thumb_url() + ')'
            summary_image_div_tag.fadeIn 350
        setTimeout success_get_next, 3000

    summary_image_tag_loader.error () ->
        error_get_next()

    get_next() unless max_i < 0

detail_init = (_photo_docs) ->
    card_height = $('#photos').height()
    if(card_height != null && card_height >= 506)
        $('.deckster_photos_scroll').css('height', card_height - 506)

    $('.deckster_photos_preview > li > img').load () ->
        $preview_img = $(this)
        EXIF.getData $preview_img[0], () ->
            $preview_img.siblings('.metadata').find('.data').find('.exif').append EXIF.pretty_html($preview_img[0])

    $('.deckster_photos_preview > li > img').error () ->
        $preview_img = $(this)
        doc_id = $preview_img.parent('li').attr 'data-doc-id'
        $(".deckster_photos_thumbnail[data-doc-id=#{doc_id}]").addClass 'full_image_error'

    $('.deckster_photos_thumbnail > img').error () ->
        $thumbnail_img = $(this)
        $thumbnail_img.parent('li').addClass 'thumb_image_error'
        $thumbnail_img.siblings('.thumbnail_cropped').css 'background-image', 'url(<%= image_path 'x.png' %>)'

    $('.deckster_photos_thumbnail > img').load () ->
        $thumbnail_img = $(this)
        url = $thumbnail_img.attr 'src'
        $thumbnail_img.siblings('.thumbnail_cropped').css 'background-image', 'url(' + url + ')'

    $('.deckster_photos_thumbnail').click () ->
        $thumbnail = $(this)
        doc_id = $thumbnail.attr 'data-doc-id'

        $('.deckster_photos_thumbnail').removeClass 'highlight'
        $thumbnail.addClass 'highlight'

        $(".deckster_photos_preview > li").fadeOut()
        $(".deckster_photos_preview > li[data-doc-id=#{doc_id}]").fadeIn()

    $(".deckster_photos_thumbnail:first").click()

preview_prev = () ->
    prev = $(".deckster_photos_preview > li:visible").prev();
    prev = $(".deckster_photos_preview > li:last") if prev.length == 0

    doc_id = prev.attr 'data-doc-id'
    $(".deckster_photos_thumbnail[data-doc-id=#{doc_id}]").click()

preview_next = () ->
    next = $(".deckster_photos_preview > li:visible").next();
    next = $(".deckster_photos_preview > li:first") if next.length == 0

    doc_id = next.attr 'data-doc-id'
    $(".deckster_photos_thumbnail[data-doc-id=#{doc_id}]").click()

window.deckster_photos =
    summary_init: summary_init
    detail_init: detail_init
    preview_prev: preview_prev
    preview_next: preview_next

$(document).on('ready', ()->
    $('body').on('keydown', (event) ->
        return unless $('.gallery').length > 0
        switch event.which
            when 37 then $('.control.previmg').click()
            when 39 then $('.control.nextimg').click()
        event.preventDefault()
    )
)