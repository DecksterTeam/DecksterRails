//
//     KeyLines v1.9.11-1545
//
//     Copyright Â© 2011-2012 Cambridge Intelligence Limited. 
//     All rights reserved.
//

var KeyLines=KeyLines||{};


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Events={}),a.createEventBus=function(){function f(a,b){var c=(new Date).toString()+" Function bound to '"+a+"' threw error: "+b.toString();e.push(c),e.length>d&&e.shift()}function g(a,b,c,d,e,f){function m(a){return((i*a+h)*a+g)*a}function n(a,b){var c=o(a,b);return((l*c+k)*c+j)*c}function o(a,b){var c,d,e,f,j,k;for(e=a,k=0;k<8;k++){f=m(e)-a;if(Math.abs(f)<b)return e;j=(3*i*e+2*h)*e+g;if(Math.abs(j)<1e-6)break;e-=f/j}c=0,d=1,e=a;if(e<c)return c;if(e>d)return d;while(c<d){f=m(e);if(Math.abs(f-a)<b)return e;a>f?c=e:d=e,e=(d-c)/2+c}return e}var g=3*b,h=3*(d-b)-g,i=1-g-h,j=3*c,k=3*(e-c)-j,l=1-j-k;return n(a,1/(200*f))}var a={},b;a.bind=function(a,c,d){b=b||{},b[a]=b[a]||[],b[a].push([c,d])},a.unbind=function(a,c){if(!b)return;if(!a)b={};else if(!c)b[a]=[];else if(b[a]){var d=[];for(var e=0;e<b[a].length;e++)c!==b[a][e][0]&&d.push(b[a][e]);b[a]=d}};var c=a.trigger=function(a){var c=!1;if(b){var d=2,e;while(d--){var g=d?a:"all",h=[],i=d?1:0;for(e=i;e<arguments.length;e++)h.push(arguments[e]);if(b[g])for(e=0;e<b[g].length;e++){var j=b[g][e];try{c=c||j[0].apply(j[1]||this,h)}catch(k){f(a,k)}}}}return c};a.getErrors=function(){return e};var d=10,e=[];a.linearEasing=function(a){return a},a.cubicEasing=function(a){return a<0?0:a>1?1:g(a,.25,.01,.25,1,1)};var h=1;return a.atanEasing=function(a){return Math.atan(h*(a-.5))/(2*Math.atan(.5*h))+.5},a}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.View={});var b=a.createView=function(a,c,d,e){function C(){return E(j*w)}function D(){return E(j/w)}function M(){return 100}var f=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,g={},h,i,j,k,l,m=c,n=d,o=e?e:1,p=g.scaleFactor=function(a){return a&&(o=a),o},q=g.scale=function(a){return Math.floor(o*a)},r=g.unscale=function(a){return Math.floor(a/o)};g.settings=function(){return{width:m,height:n,zoom:j,offsetX:k,offsetY:l}},g.fromSettingsDirect=function(a,b,c,d){return O(j,a.zoom,a.offsetX-k,a.offsetY-l,b,c,d)},g.fromOldSettings=function(c,d,e,f){if(d){var g=b(a,c.width,c.height);g.setZoom(c.zoom,!1),g.offsetX=c.offsetX,g.offsetY=c.offsetY;var h={x1:g.newToOldX(0),y1:g.newToOldY(0),x2:g.newToOldX(g.width()),y2:g.newToOldY(g.height())};return G(h,e,!1,!1,!1,f)}F(c.zoom,!1),k=c.offsetX,l=c.offsetY},g.width=function(a){return a&&(m=a),m},g.height=function(a){return a&&(n=a),n};var s=g.x=g.oldToNewX=function(a){return Math.floor(((a-h)*j+k)*o)},t=g.y=g.oldToNewY=function(a){return Math.floor(((a-i)*j+l)*o)},u=g.newToOldX=function(a){return Math.floor((a/o-k)/j+h)},v=g.newToOldY=function(a){return Math.floor((a/o-l)/j+i)};g.w=function(a){return Math.max(1,Math.floor(a*j*o))},g.dim=function(a){return Math.floor(a*j*o)},g.undim=function(a){return Math.floor(a/(j*o))};var w=1.4,x=4,y=.05,z=200;g.maxZoom=function(){return x},g.minZoom=function(){return y};var A=g.zoomIn=function(a,b,c){var d=C();return J(d,o*m/2,o*n/2,a,b,c)},B=g.zoomOut=function(a,b,c){var d=D();return J(d,o*m/2,o*n/2,a,b,c)},E=function(a){return Math.min(x,Math.max(a,y))},F=g.setZoom=function(a,b,c,d){var e=E(a);return J(e,o*m/2,o*n/2,b,c,d)};g.wheelToPosition=function(a,b,c){var d=a>0?C():D();return J(d,b,c,!0,200)},g.fitWorldExtents=function(a,b,c,d,e,g,h){if(!a)return f.invoke(h),null;var i={x1:s(a.x1),y1:t(a.y1),x2:s(a.x2),y2:t(a.y2)};return G(i,b,c,d,e,g,!1,h)};var G=g.fitExtents=function(a,b,c,d,e,f,g,p){var q=(a.y2-a.y1)/(a.x2-a.x1),r=n/m,s;if(q>r){var t=e?n/8:0;s=j*(n-t)/(a.y2-a.y1)}else{var w=e?m/8:0;s=j*(m-w)/(a.x2-a.x1)}s*=o,c&&(s=E(s)),d&&s>1&&(s=1);var x=(a.x1+a.x2)/2,y=(a.y1+a.y2)/2,z=u(x),A=v(y),B=m/2-(z-h)*s,C=n/2-(A-i)*s;return O(j,s,B-k,C-l,b,f,p,g)};g.fitToSelection=function(a,b,c,d,e,f,h,i){var j=d.instructionPool();return a.generateSelection(j,b,g,c,undefined,i),H(b,j,d,e,f,h)};var H=function(a,b,c,d,e,f){var g=c.getUnionExtents3(a,b);return g?G(g,d,!0,!0,!0,e,!1,f):null},I=g.modelExtents=function(a,b,c,d,e){var f=d.instructionPool();return a.generate(f,b,g,c,null,null,e),d.getUnionExtents3(b,f)};g.fitToModel=function(a,b,c,d,e,f,h,i){var j=d.instructionPool();return a.generate(j,b,g,c,null,null,i),H(b,j,d,e,f,h)};var J=g.zoomToPosition=function(a,b,c,d,e,f){a=E(a);var g=u(b),m=v(c),n=b/o-(g-h)*a,p=c/o-(m-i)*a;return O(j,a,n-k,p-l,d,e,f)},K=g.reset=function(b,c){h=421,i=298,b?O(j,1,421-k,298-l,!0):(k=421,l=298,j=1),a&&!c&&a.trigger("zoom1to1")},L=g.zoom=function(){return j};g.offsetX=function(){return k},g.offsetY=function(){return l},g.panLeft=function(a,b,c){return N(M(),0,a,!1,b,c)},g.panRight=function(a,b,c){return N(-M(),0,a,!1,b,c)},g.panUp=function(a,b,c){return N(0,M(),a,!1,b,c)},g.panDown=function(a,b,c){return N(0,-M(),a,!1,b,c)};var N=g.panBy=function(a,b,c,d,e,f){return O(j,j,a,b,c,e,f,d)},O=function(b,c,d,e,g,h,i,m){if(g)return T(b,c,d,e,h,i);k+=Math.floor(d),l+=Math.floor(e),j=c,a&&!m&&a.trigger("viewchange"),f.invoke(i)},P=1e3,Q=Math.log(1e-5),R=Math.log(x),S=function(a){if(a<x){var b=Math.max(Q,Math.log(a)),c=Math.floor(P*(b-Q)/(R-Q))/P+Q;return Math.exp(c)}return x},T=function(b,c,d,e,g,h){g||(g=z);var i=g,m=k,n=l;return{animate:function(o){i-=o;var p=a.atanEasing(Math.max(0,Math.min(1,(g-i)/g)));k=m+p*d,l=n+p*e,j=E(b+p*(c-b));var q=i>0;return q||(a.trigger("viewchange"),f.invoke(h)),q}}},U=function(){var b=.1;return{animate:function(c){var d=W===0&&X===0;return k+=c*b*W,l+=c*b*X,V=!d,d||a.trigger("viewchange"),!d}}},V,W,X;return g.cancelScroll=function(){W=X=0},g.maybeScroll=function(a,b){var c=q(50);W=0,X=0,a<c&&(W=1),a>q(m)-c&&(W=-1),b<c&&(X=1),b>q(n)-c&&(X=-1);if(W!==0||X!==0)if(!V)return V=!0,U()},K(),g}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Draggers={}),a.createDraggers=function(a){var b=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,c={};return c.primitiveMover=function(c,d,e,f,g,h,i,j,k,l){function p(a,b){return{dx:a-j,dy:b-k}}function q(a,c,d,e){var f={},g;if(i.length>0){f.x1=f.x2=f.y1=f.y2=0;for(var h=0;h<i.length;h++){g=i[h];var j=g.charAt(0)==="x"?a:c;f[g]=j}d&&(f.x1!==0&&(f.x2=-f.x1),f.x2!==0&&(f.x1=-f.x2),f.y1!==0&&(f.y2=-f.y1),f.y2!==0&&(f.y1=-f.y2))}else e&&(a=Math.abs(a)>Math.abs(c)?a:0,c=a!==0?0:c),f.x1=f.x2=a,f.y1=f.y2=c;var k={},l=["x1","y1","x2","y2"];for(var n=0;n<l.length;n++)g=l[n],k[g]=m[g]+f[g];if(e){var o=m.x2-m.x1,p=m.y2-m.y1;if(Math.abs(o)>0&&Math.abs(p)>0){var q=p/o,r=k.x2-k.x1,s=k.y2-k.y1,t=Math.abs(a)>Math.abs(c),u;if(t){var v=Math.floor(q*(o+r)-p)-s;d||!b.contains(i,"y1")&&!b.contains(i,"y2")?(u=Math.floor(v/2),k.y1-=u,k.y2+=u):(b.contains(i,"y1")&&(k.y1-=v),b.contains(i,"y2")&&(k.y2+=v))}else{var w=Math.floor((p+s)/q-o)-r;d||!b.contains(i,"x1")&&!b.contains(i,"x2")?(u=Math.floor(w/2),k.x1-=u,k.x2+=u):(b.contains(i,"x1")&&(k.x1-=w),b.contains(i,"x2")&&(k.x2+=w))}}}return k}function r(a,b,c,d){var e=p(a,b);return q(e.dx,e.dy,c,d)}if(a.trigger("dragstart","resize",f,e.unscale(j),e.unscale(k),null))return;var m=c.extents(d,g),n={};for(var o in g)n[o]=g[o];c.setAlpha(n,.5);var s={scrollable:!0,getCursor:function(a,b){return h?"crosshair":"move"},generate:function(a){a.copyPrimitive(n)},dragMove:function(a,b,e,f){var g=r(a,b,e,f);c.setExtents(n,g.x1,g.y1,g.x2,g.y2,d)},endDrag:function(b,h,i,j,k){e.cancelScroll();var m=a.trigger("dragend","resize",f,e.unscale(h),e.unscale(i));if(!m&&b){var n=r(h,i,j,k);c.setExtents(g,n.x1,n.y1,n.x2,n.y2,d),l(g)}a.trigger("dragcomplete","resize",f,e.unscale(h),e.unscale(i))}};return s},c.createDefaultDragger=function(c,d,e,f,g,h,i){function n(a){return k&&k[a]}function t(){for(var a in c){var b=j?d(a)||n(a):!0;b&&q[a]&&(c[a].x=q[a].x+s.dx,c[a].y=q[a].y+s.dy)}}function u(){for(var a in c)q[a]&&(c[a].x=q[a].x,c[a].y=q[a].y)}function w(a,b){return v=v||Math.abs(h-a)>10||Math.abs(i-b)>10,a=f?f.newToOldX(a):a,b=f?f.newToOldY(b):b,{dx:v?a-o:0,dy:v?b-p:0}}function x(){return j?"move":"hand"}var j=g!==null,k=null,l=b.rawId(g),m=a.trigger("dragstart",x(),l,f.unscale(h),f.unscale(i),b.subId(g));if(m)if(b.isArray(m))k=b.makeIdMap(m);else return;var o=f?f.newToOldX(h):h,p=f?f.newToOldY(i):i,q={};for(var r in c)q[r]={x:c[r].x,y:c[r].y};var s=w(h,i),v=!1,y,z,A={scrollable:j,animate:function(a){t()},excludeHit:function(){var a={};return g!==null&&(a[g]=1),a},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){s=w(a,b)},mouseMoved:function(a){return a&&(y=!0),y},afterDraw:function(c,d,e){y=!1;var g=b.rawId(c);if(l===g)return;typeof z=="undefined"?z=g:g!==z&&(a.trigger("dragover",g,f.unscale(d),f.unscale(e),b.subId(c)),z=g)},endDrag:function(c,d,e,h,i){f.cancelScroll();var j=a.trigger("dragend",x(),b.rawId(g),f.unscale(d),f.unscale(e));j?u():c&&v?(u(),a.trigger("prechange","move"),s=w(d,e),t()):u(),a.trigger("dragcomplete",x(),b.rawId(g),f.unscale(d),f.unscale(e))}};return A},c.createLinkEndDragger=function(c,d,e,f,g,h,i,j,k){function p(a,b){f[g[h]].x=a,f[g[h]].y=b}function u(a,b){return a=e?e.newToOldX(a):a,b=e?e.newToOldY(b):b,{dx:a-l,dy:b-m}}if(a.trigger("dragstart","dummy",k,e.unscale(i),e.unscale(j),null))return!1;var l=e?e.newToOldX(i):i,m=e?e.newToOldY(j):j,n=f[g[h]].x,o=f[g[h]].y,q=u(i,j),r=i,s=j,t=null,v={scrollable:!0,animate:function(a){p(n+q.dx,o+q.dy)},getCursor:function(a,b){return"move"},dragMove:function(a,b,d,e){q=u(a,b),r=a,s=b,t=c.hittest(a,b),!t},endDrag:function(c,i,j,k,l){e.cancelScroll();var m=a.trigger("dragend","dummy",t,e.unscale(i),e.unscale(j));m||(c?(p(n,o),a.trigger("prechange","move"),d.isNode(t)?(delete f[g[h]],g[h]=b.rawId(t)):(q=u(i,j),p(n+q.dx,o+q.dy))):p(n,o)),a.trigger("dragcomplete","dummy",t,e.unscale(i),e.unscale(j))}};return v},c.createLinkDragger=function(c,d,e,f,g,h,i){function j(a,b,c,d,e,f){return((c-a)*(b-f)-(a-e)*(d-b))/Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))}function k(a,b,c,d,e,f){return{x:((e-c)*Math.cos(b)-(f-d)*Math.sin(b))/a,y:((e-c)*Math.sin(b)+(f-d)*Math.cos(b))/a}}function l(a,b,c,d,e,f){var g=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b)),h=Math.atan2(d-b,c-a),i=k(g,-h,a,b,e,f);return i.x}function p(a,b){var d=e.newToOldX(a),g=e.newToOldY(b),h=c("x1",f),i=c("y1",f),k=c("x2",f),p=c("y2",f),q=j(h,i,k,p,d,g),r=l(h,i,k,p,d,g);o&&Math.abs(q-m)>8&&(o=!1),o||(Math.abs(q)<12&&(q=0),n=q)}function q(){f.off=n}if(a.trigger("dragstart","offset",i,e.unscale(g),e.unscale(h),b.subId(i)))return!1;var m=f.off?f.off:0,n=m,o=!0,r={scrollable:!0,animate:function(a){q()},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){p(a,b)},endDrag:function(b,c,d,g,h){e.cancelScroll();var j=a.trigger("dragend","offset",i,e.unscale(c),e.unscale(d));j||(b?(f.off=m,a.trigger("prechange","offset"),p(c,d),q()):f.off=m),a.trigger("dragcomplete","offset",i,e.unscale(c),e.unscale(d))}};return r},c}})();


(function(){function d(){function i(a){var b={};if(a)for(var c=0;c<a.length;c++)b[a[c]]=1;return b}var d={},e=[],f;for(var g in c)e.push(b());var h=d.layer=function(a){return f=e[a],f};return h(c.NODES),d.reset=function(a){var b=i(a);for(var c=0;c<e.length;c++)(!a||b[c])&&e[c].reset()},d.getLast=function(){return f.getLast()},d.each=function(a,b){var c=i(b);for(var d=0;d<e.length;d++)(!b||c[d])&&e[d].each(a)},d.line=function(b,c,d,e,g,h,i){var j=f.getNext();j.p=a.primitives.line,j.x1=b,j.y1=c,j.x2=d,j.y2=e,j.c=g,j.w=h,j.id=i},d.circle=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.circle,k.x=b,k.y=c,k.r=d,k.bc=e,k.bw=g,k.fc=h,k.fi=i,k.id=j},d.arc=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.arc,k.x=b,k.y=c,k.r=d,k.sa=e,k.ea=g,k.bc=h,k.bw=i,k.id=j},d.text=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.text,k.x=b,k.y=c,k.t=d,k.c=e,k.fs=g,k.bo=h,k.ff=j,k.id=i},d.image=function(b,c,d,e,g,h,i){var j=f.getNext();j.p=a.primitives.image,j.x1=b,j.y1=c,j.x2=d,j.y2=e,j.u=g,j.id=h,j.s=i},d.rect=function(b,c,d,e,g,h,i,j,k){var l=f.getNext();l.p=a.primitives.rect,l.x1=b,l.y1=c,l.x2=d,l.y2=e,l.bc=g,l.bw=h,l.fc=i,l.fi=j,l.id=k},d.round=function(b,c,d,e,g,h,i,j,k,l){var m=f.getNext();m.p=a.primitives.round,m.x1=b,m.y1=c,m.x2=d,m.y2=e,m.r=g,m.bc=h,m.bw=i,m.fc=j,m.fi=k,m.id=l},d.triangle=function(b,c,d,e,g,h,i,j,k,l,m){var n=f.getNext();n.p=a.primitives.triangle,n.x1=b,n.y1=c,n.x2=d,n.y2=e,n.x3=g,n.y3=h,n.bc=i,n.bw=j,n.fc=k,n.fi=l,n.id=m},d.path=function(b,c,d,e,g){var h=f.getNext();h.p=a.primitives.path,h.cmds=b,h.pts=c,h.c=d,h.w=e,h.id=g},d.copyPrimitive=function(a){var b=f.getNext();for(var c in a)b[c]=a[c]},d}function I(b,c,d){switch(d.p){case a.primitives.circle:K(b,d.x,d.y,d.r,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.arc:L(b,d.x,d.y,d.r,d.sa,d.ea,d.bc,d.bw);break;case a.primitives.line:M(b,d.x1,d.y1,d.x2,d.y2,d.c,d.w);break;case a.primitives.text:N(b,d.x,d.y,d.t,d.c,d.fs,d.bo,d.ff);break;case a.primitives.image:P(b,c[d.u],d.x1,d.y1,d.x2,d.y2,d.s);break;case a.primitives.rect:O(b,d.x1,d.y1,d.x2,d.y2,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.round:Q(b,d.x1,d.y1,d.x2,d.y2,d.r,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.triangle:R(b,d.x1,d.y1,d.x2,d.y2,d.x3,d.y3,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.path:J(b,d.cmds,d.pts,d.c,d.w)}}function J(a,b,c,d,e){if(a.hasOwnProperty("doPath"))a.doPath(b,c,d,e);else{e>=0&&(a.lineWidth=e,a.strokeStyle=d,a.beginPath());var f=0;for(var g=0;g<b.length;g++)switch(b[g]){case 1:a.moveTo(c[f++],c[f++]);break;case 2:a.lineTo(c[f++],c[f++]);break;case 3:a.quadraticCurveTo(c[f++],c[f++],c[f++],c[f++])}e>=0&&(a.stroke(),a.closePath())}}function K(a,b,c,d,e,g,h,i){i?a.fillStyle=h:a.fillStyle=f.transparent,g<0?a.strokeStyle=f.transparent:(a.lineWidth=g,a.strokeStyle=e),a.beginPath(),a.arc(b,c,d,0,Math.PI*2,!0),a.closePath(),i&&a.fill(),g>=0&&a.stroke()}function L(a,b,c,d,e,f,g,h){a.lineWidth=h,a.strokeStyle=g,a.beginPath(),a.arc(b,c,d,e,f,!1),a.stroke(),a.closePath()}function M(a,b,c,d,e,f,g){a.lineWidth=g,a.lineCap="butt",a.strokeStyle=f,a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke(),a.closePath()}function N(a,b,c,d,e,f,g,h){s(a,f,g,h),a.fillStyle=e,a.fillText(d,b,c)}function O(a,b,c,d,e,f,g,h,i){i&&(a.fillStyle=h,a.fillRect(b,c,d-b,e-c)),g>=0&&(a.lineWidth=g,a.strokeStyle=f,a.strokeRect(b,c,d-b,e-c))}function P(a,b,c,d,e,f,g){var h=b[g?g:"im"];a.drawImage(h,0,0,h.width,h.height,c,d,e-c,f-d)}function Q(a,b,c,d,e,f,g,h,i,j){a.beginPath(),a.moveTo(b+f,c),a.arcTo(d,c,d,e,f),a.arcTo(d,e,b,e,f),a.arcTo(b,e,b,c,f),a.arcTo(b,c,b+f,c,f),a.closePath(),j&&(a.fillStyle=i,a.fill()),h>=0&&(a.lineWidth=h,a.strokeStyle=g,a.stroke())}function R(a,b,c,d,e,f,g,h,i,j,k){if(a.drawTriangle){a.drawTriangle(b,c,d,e,f,g,h,i,j,k);return}a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.lineTo(f,g),a.lineTo(b,c),a.closePath(),k&&(a.fillStyle=j,a.fill()),i>=0&&(a.lineWidth=i,a.strokeStyle=h,a.stroke())}function S(a,b){var c={};for(var d in a){var e=a[d],f=b(e.width,e.height),g=f.getContext("2d");g.fillStyle="rgb(255, 0, 254)",g.fillRect(0,0,e.width,e.height),g.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),c[d]=f}return c}function T(a,b,c){a/=255,b/=255,c/=255;var d=Math.max(a,b,c),e=Math.min(a,b,c),f,g,h=(d+e)/2;if(d===e)f=g=0;else{var i=d-e;g=h>.5?i/(2-d-e):i/(d+e);switch(d){case a:f=(b-c)/i+(b<c?6:0);break;case b:f=(c-a)/i+2;break;case c:f=(a-b)/i+4}f/=6}return[f,g,h]}function U(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}function V(a,b,c){var d,e,f;if(b===0)d=e=f=c;else{var g=c<.5?c*(1+b):c+b-c*b,h=2*c-g;d=U(h,g,a+1/3),e=U(h,g,a),f=U(h,g,a-1/3)}return[Math.floor(d*255),Math.floor(e*255),Math.floor(f*255)]}function W(b,c,d){var e=d(b.width,b.height),f=e.getContext("2d"),g=a.convertrgb(c),h=b.getContext("2d").getImageData(0,0,b.width,b.height),i=h.data;for(var j=0;j<i.length;j+=4)i[j]===255&&i[j+1]===0&&i[j+2]===254?(h.data[j]=0,h.data[j+1]=0,h.data[j+2]=0,h.data[j+3]=0):(h.data[j]=g[0],h.data[j+1]=g[1],h.data[j+2]=g[2],h.data[j+3]=255);return f.putImageData(h,0,0),e}var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Rendering={});var b=function(){function d(){return a[b]||(a[b]={}),a[b++]}var a=[],b=0,c="out of range error";return{reset:function(){b=0},each:function(c){for(var d=0;d<b;d++)c(a[d])},getNext:d,getLast:function(){if(b>0)return a[b-1];throw c}}};a.pool=function(){return b()};var c=a.layers={UNDERLAYS:0,GHOSTSHAPES:1,SHAPES:2,HANDLES:3,GHOSTLINKS:4,GHOSTNODES:5,LINKS:6,NODES:7,DRAGGERS:8,OVERLAYS:9,TOUCHES:10,OVERVIEW:11,WAIT:12};a.modelLayers=[c.GHOSTSHAPES,c.SHAPES,c.GHOSTLINKS,c.GHOSTNODES,c.LINKS,c.NODES,c.HANDLES],a.ghostLayers=[c.GHOSTSHAPES,c.GHOSTLINKS,c.GHOSTNODES],a.fullLayers=[c.SHAPES,c.LINKS,c.NODES,c.HANDLES],a.overviewLayers=[c.SHAPES,c.LINKS,c.NODES,c.OVERLAYS],a.topLayers=[c.SHAPES,c.LINKS,c.NODES,c.HANDLES,c.DRAGGERS,c.OVERLAYS],a.hitLayers=[c.SHAPES,c.LINKS,c.NODES,c.HANDLES,c.OVERLAYS,c.OVERVIEW],a.instructionPool=function(){return d()};var e=a.primitives={circle:"C",arc:"A",line:"L",text:"T",image:"I",rect:"R",round:"RR",triangle:"TR",path:"P"},f=a.colours={aqua:"rgb(0, 255, 255)",black:"rgb(0, 0, 0)",blue:"rgb(0, 0, 255)",fuchsia:"rgb(255, 0, 255)",green:"rgb(0, 128, 0)",grey:"rgb(128, 128, 128)",lime:"rgb(0, 255, 0)",maroon:"rgb(128, 0, 0)",navy:"rgb(0, 0, 128)",olive:"rgb(128, 128, 0)",purple:"rgb(128, 0, 128)",red:"rgb(255, 0, 0)",silver:"rgb(192, 192, 192)",teal:"rgb(0, 128, 128)",yellow:"rgb(255, 255, 0)",white:"rgb(255, 255, 255)",ci:"rgb(0, 174, 239)",cia:"rgba(0, 174, 239, 0.5)",keyline:"rgb(88, 89, 91)",midgrey:"rgb(145, 146, 149)",lightgrey:"rgb(208, 209, 211)",edit:"rgb(114, 179, 0)",attention:"rgb(220, 0, 0)",information:"rgb(0, 150, 255)",description:"rgb(255, 175, 0)",textback:"rgba(255,255,255,0.6)",transparent:"rgba(255,255,255,0.0)",touch:"rgba(255,0,0,0.6)"},g=a.rgbtostring=function(a,b,c){return"rgb("+a+","+b+","+c+")"},h=a.rgbatostring=function(a,b,c,d){return"rgba("+a+","+b+","+c+","+d+")"},i=/^(?:rgb)?\((0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2})\s?\)$/i,j=/^(?:rgba)?\((0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|1|0\.\d{0,10})\)$/i,k=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i,l=/^#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])$/i,m=a.convertrgb=function(a){var b,c=[],d=f[a.toLowerCase()];a=d?d:a;var e=a.match(i);e||(e=a.match(j));if(e)for(b=1;b<4;b++)c.push(parseInt(e[b],10));else{e=a.match(l);if(!e){e=a.match(k);if(e)for(b=1;b<4;b++)e[b]=""+e[b]+e[b]}if(e)for(b=1;b<4;b++)c.push(parseInt(e[b],16))}return c},n=a.opacity=function(a){var b=a.match(j);return b?parseFloat(b[4]):1};a.hsla=function(a){var b=m(a),c=T(b[0],b[1],b[2]);return c.push(n(a)),c},a.fromhsla=function(a){var b=V(a[0],a[1],a[2]);return h(b[0],b[1],b[2],a[3])};var o=a.rgbtohex=function(a){var b=m(a),c="";for(var d=0;d<b.length;d++){var e=b[d];c+=(e<16?"0":"")+e.toString(16)}return c},p=function(a){function b(){return Math.floor(Math.random()*255)}var c=g(b(),b(),b());return c in a?p(a):c},q={};a.clearLastFont=function(){q={}};var r="Ubuntu",s=a.setFont=function(a,b,c,d){c=c?!0:!1,d=d?d:r;if(a===q.context&&b===q.fontSize&&c===q.bold&&d===q.family)return;q.context=a,q.fontSize=b,q.bold=c,q.family=d;var e=c?"bold":"normal",f="normal",g="px",h=f+" "+e+" "+b+g+" "+d;a.font=h,a.textAlign="left",a.textBaseline="bottom"};a.test_instructions=[{p:e.circle,x:100,y:100,r:50,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.line,x1:200,y1:200,x2:300,y2:300,c:f.green,w:3},{p:e.text,x:400,y:450,t:"Cambridge Intelligence",c:f.grey,fs:16},{p:e.rect,x1:200,y1:50,x2:300,y2:80,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.round,x1:400,y1:50,x2:500,y2:80,r:10,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.image,x1:300,y1:100,x2:556,y2:256,u:"icon/identity.png"},{p:e.image,x1:50,y1:300,x2:206,y2:556,u:"icon/laptop.png"}];var t=a.setAlpha=function(a,b){var c=["c","fc","bc"];for(var d=0;d<c.length;d++){var e=c[d];if(e in a){var f=m(a[e]);a[e]=h(f[0],f[1],f[2],b)}}},u=a.alphaize=function(a,b){var c=m(a);return h(c[0],c[1],c[2],b)},v=a.setExtents=function(b,c,d,e,f,g){var h,i;switch(b.p){case a.primitives.circle:h=Math.abs((e-c)/2),i=Math.abs((f-d)/2),b.x=Math.floor(Math.min(c,e)+h),b.y=Math.floor(Math.min(d,f)+i),b.r=Math.floor(Math.min(h,i));break;case a.primitives.line:case a.primitives.rect:case a.primitives.round:b.x1=Math.min(c,e),b.x2=Math.max(c,e),b.y1=Math.min(d,f),b.y2=Math.max(d,f);break;case a.primitives.text:b.x=Math.min(c,e),b.y=Math.max(d,f);break;case a.primitives.image:b.x1=Math.min(c,e),b.y1=Math.min(d,f),b.x2=Math.max(c,e),b.y2=Math.max(d,f);break;case a.primitives.triangle:}},w=a.extents=function(b,c){var d,e,f,g;switch(c.p){case a.primitives.circle:d=c.x-c.r,e=c.x+c.r,f=c.y-c.r,g=c.y+c.r;break;case a.primitives.line:case a.primitives.rect:case a.primitives.round:case a.primitives.image:d=Math.min(c.x1,c.x2),e=Math.max(c.x1,c.x2),f=Math.min(c.y1,c.y2),g=Math.max(c.y1,c.y2);break;case a.primitives.text:var h=H(b,c.t,c.fs,c.bo,c.ff);d=c.x,f=c.y-h.height,e=c.x+h.width,g=c.y;break;case a.primitives.triangle:d=Math.min(c.x1,c.x2,c.x3),e=Math.max(c.x1,c.x2,c.x3),f=Math.min(c.y1,c.y2,c.y3),g=Math.max(c.y1,c.y2,c.y3);break;case a.primitives.arc:var i=c.x+c.r*Math.cos(c.sa),j=c.y+c.r*Math.sin(c.sa),k=c.x+c.r*Math.cos(c.ea),l=c.y+c.r*Math.sin(c.ea);d=Math.min(i,k),e=Math.max(i,k),f=Math.min(j,l),g=Math.max(j,l);var m=(Math.floor(c.sa/(Math.PI/2))+1)*Math.PI/2;while(m<c.ea){var n=c.x+c.r*Math.cos(m),o=c.y+c.r*Math.sin(m);d=Math.min(d,n),e=Math.max(e,n),f=Math.min(f,o),g=Math.max(g,o),m+=Math.PI/2}}return{x1:d,y1:f,x2:e,y2:g}},x=a.join=function(a,b){return{x1:Math.min(a.x1,b.x1),y1:Math.min(a.y1,b.y1),x2:Math.max(a.x2,b.x2),y2:Math.max(a.y2,b.y2)}};a.inside=function(a,b,c){return a.x1<=b&&b<=a.x2&&a.y1<=c&&c<=a.y2},a.insideCircle=function(a,b,c,d,e,f){f||(f=0);var g=Math.sqrt((a-d)*(a-d)+(b-e)*(b-e));return g+f<c},a.rectContains=function(a,b,c,d,e){return a.x1<b&&d<a.x2&&a.y1<c&&e<a.y2},a.circleContains=function(a,b,c,d,e,f,g){var h=(a-d)*(a-d)+(b-e)*(b-e),i=(a-d)*(a-d)+(b-g)*(b-g),j=(a-f)*(a-f)+(b-e)*(b-e),k=(a-f)*(a-f)+(b-g)*(b-g),l=c*c;return h<l&&i<l&&j<l&&k<l},a.intersects=function(a,b){return!(b.x1>a.x2||b.x2<a.x1||b.y1>a.y2||b.y2<a.y1)};var y=function(a){switch(a.length){case 0:return undefined;case 1:return a[0];default:var b=a[0];for(var c=1;c<a.length;c++)b=x(b,a[c]);return b}},z=function(a,b,c,d,e){var f=[],g=Math.floor((b.x2-b.x1)/2),h=Math.floor((b.y2-b.y1)/2),i=1,j="-resize",k=Math.floor(4*c);B(a,{x:b.x1,y:b.y1},k,i,d+"#nw"+j,e),A(a,{x:b.x1+g,y:b.y1},k,i,d+"#n"+j,e),B(a,{x:b.x2,y:b.y1},k,i,d+"#ne"+j,e),A(a,{x:b.x2,y:b.y1+h},k,i,d+"#e"+j,e),B(a,{x:b.x2,y:b.y2},k,i,d+"#se"+j,e),A(a,{x:b.x2-g,y:b.y2},k,i,d+"#s"+j,e),B(a,{x:b.x1,y:b.y2},k,i,d+"#sw"+j,e),A(a,{x:b.x1,y:b.y2-h},k,i,d+"#w"+j,e)},A=function(a,b,c,d,e,g){a.rect(b.x-c,b.y-c,b.x+c,b.y+c,g,d,f.white,!0,e)},B=function(a,b,c,d,e,g){a.circle(b.x,b.y,c+1,g,d,f.white,!0,e)};a.getHandles=function(a,b,c,d,e,f){var g=w(b,c);z(a,g,d,e,f)};var C=a.getUnionExtents3=function(a,b){function d(b){c.push(w(a,b))}var c=[];return b.each(d),y(c)},D=a.images=function(b){function d(b){b.p===a.primitives.image&&(c[b.u]={})}var c={};return b.each(d),c},E=a.imageLoader=function(a,b,c,d){function i(){if(e+f===g)try{d(f>0,h)}catch(a){d("callback to image loader threw exception "+a)}}function j(a){f++,i()}function k(a){e++,i()}var e=0,f=0,g=0,h={};for(var l in c){g++;var m=a();m.onload=k,m.onerror=j,h[l]=m}g===0&&d(null,h);for(var n in h)h[n].src=b+n},F=a.draw6=function(a,b,c,d){function e(b){I(a,c,b)}b.each(e,d)};a.clear=function(a){a.clearRect(0,0,a.canvas.width,a.canvas.height)};var G=a.fillWhite=function(a){a.fillStyle=f.white,a.fillRect(0,0,a.canvas.width,a.canvas.height)};a.backgroundGradient=function(a,b){if(b)if(a.hasOwnProperty("doGradient"))a.doGradient(Math.PI/2,b);else{var c=a.createLinearGradient(0,0,0,a.canvas.height);for(var d=0;d<b.length;d++)c.addColorStop(b[d].r,b[d].c);a.fillStyle=c,a.fillRect(0,0,a.canvas.width,a.canvas.height)}};var H=a.measureText=function(a,b,c,d,e){s(a,c,d,e);var f=a.measureText(b).width,g=c;return{width:f,height:g}};a.circularize=function(a,b,c){var d=!1,e={},g;try{for(g in a)if(g in b&&b[g]){var h=a[g].im,i=Math.min(h.width,h.height),j=i<h.height?Math.floor((h.height-i)/2):0,k=i<h.width?Math.floor((h.width-i)/2):0,l=Math.floor(i/2),m=c(i,i),n=m.getContext("2d");n.clearRect(0,0,i,i),n.drawImage(h,k,j,i,i,0,0,i,i);var o=c(i,i),p=o.getContext("2d");p.clearRect(0,0,i,i),K(p,l,l,l,f.white,-1,f.black,!0);var q=p.getImageData(0,0,i,i).data,r=n.getImageData(0,0,i,i),s=r.data;for(var t=0;t<s.length;t+=4)q[t+3]===0&&(s[t+3]=0);n.clearRect(0,0,i,i),n.putImageData(r,0,0),m.src=h.src+"#ci",e[g]=m}}catch(u){d=!0}for(g in e)a[g].ci=d?a[g].im:e[g]},a.colorize=function(a,b,c,d,e){var f=.02,g=m(d),h=T(g[0],g[1],g[2]),i={},j=m(e),k=T(j[0],j[1],j[2]),l=V(k[0],k[1],h[2]);for(var n in a)if(n in b&&b[n]){var o=a[n].im,p=c(o.width,o.height),q=p.getContext("2d");q.clearRect(0,0,o.width,o.height),q.drawImage(o,0,0,o.width,o.height,0,0,o.width,o.height);var r=q.getImageData(0,0,o.width,o.height),s=r.data;for(var t=0;t<s.length;t+=4){var u=T(s[t],s[t+1],s[t+2]);if(Math.abs(u[0]-h[0])<f){var v=V(k[0],k[1],u[2]);r.data[t]=v[0],r.data[t+1]=v[1],r.data[t+2]=v[2]}}q.clearRect(0,0,o.width,o.height),q.putImageData(r,0,0),p.src=o.src+e,i[n]=p}return{images:i,colour:l}},a.drawShadowCanvas=function(b,c,d,e,f,g,h){function n(b){var c=g.getColour(b.id);if(b.p===a.primitives.image)if(f)b.p=a.primitives.rect,b.fi=!0,b.fc=c,b.bc=c,b.bw=1;else{var e=b.u+c;j[e]=W(i[b.u],c,d),b.u=e}for(l=0;l<k.length;l++)b[k[l]]&&(b[k[l]]+=7);b.p===a.primitives.text&&(b.p=""),h&&h[b.id]&&(b.p="");for(l=0;l<m.length;l++)b[m[l]]&&(b[m[l]]=c)}var i;f||(i=S(e,d));var j={},k=["bw","w"],l,m=["c","fc","bc"];c.each(n),F(b,c,j)}})();


(function(){function c(){return{doSelection:function(a){},isSelected:function(a){return!1},setSelection:function(a,b,c){},moveSelection:function(a,b){},hasSelection:function(){return!1},selectAll:function(){},deleteSelection:function(){},createDragger:function(a,b,c,d,e,f,g,h){return null},createGestureDragger:function(a,b,c){return null},getByID:function(a){},setItem:function(a){},removeItem:function(a){},setProperties:function(a,b){},labelPosition:function(a,b){},hide:function(a){},hidden:function(){},show:function(a,b){},ghost:function(a){},resurrect:function(a,b){},makeAnimator:function(a,b){},applyVertices:function(a){},layout:function(a,b,c,d){},hierarchy:function(a,b,c,d){},merge:function(a){},serialize:function(a){},imageList:function(){return[]},interactionOptions:function(a){return{}},animated:function(){},editColour:function(a){},getCursor:function(a){},getResizePrimitive:function(){}}}function d(){function d(a){var b=0;while(c[b].max<a)b++;return c[b]}function e(c,d,e,f,g,i,j,k,l,m){var n=[],o=[],p=e;while(p<=f)n.push(p),o.push(h(p,g,i,j)),p=a.add(p,m.units,m.by);var q=b.colours.grey;for(var r=0;r<n.length;r++){var s=o[r];c.line(s,k-l,s,k,q,1,"_tick"+r);if(r<n.length-1){var u=a.format(n[r],m.f),v=b.measureText(d,u,10,!1).width,w=m.left?o[r]+3:Math.floor((o[r+1]+o[r])/2-v/2);c.text(w,k,u,q,10,!1,"_tick"+r)}}}function f(c,f,i,j,k,l,m,n){if(m===n)return;if(k===l)return;var o=g(k,l,m,n),p=2/3,q=p*o*(l-k),r=a.add(m,a.units.milli,-q),s=a.add(n,a.units.milli,q),u=g(k,l,r,s),v=d(u),w=[],x=[],y=a.add(r,a.units.milli,-q/2),z=a.add(s,a.units.milli,q/2),A=a.clear(y,v.clear.units,v.clear.by);e(c,f,A,z,k,r,u,i-10,13,v.major),v.minor&&e(c,f,A,z,k,r,u,i-23,10,v.minor);var B=i+j-10,C=3,D=h(m,k,r,u),E=h(n,k,r,u);c.rect(D,B+C,E,i+j,b.colours.cia,-1,b.colours.cia,!0,"_tbFill"),c.line(D,B+C,D,i+j,b.colours.ci,2,"_tbLeft"),c.line(E,B+C,E,i+j,b.colours.ci,2,"_tbRight")}function g(a,b,c,d){return(d.getTime()-c.getTime())/(b-a)}function h(a,b,c,d){return Math.floor(b+(a.getTime()-c.getTime())/d)}var a=typeof KeyLinesRequire!="undefined"?require("./datetime"):KeyLines.DateTime,b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=[{max:2e7,clear:{units:a.units.month,by:1},major:{units:a.units.month,by:1,f:"MMMM yyyy"},minor:{units:a.units.week,by:1,f:"d",left:!0,clear:{units:a.units.week,by:1},add:function(b){var c=a.clone(b),d=c.getDate();c>=10&&c>=20&&c.setDate(0)}}},{max:3e7,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMMM"}},{max:5e7,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMM"}},{max:1e8,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMMMM"}},{max:2e8,clear:{units:a.units.month,by:6},major:{units:a.units.month,by:6,f:"QQ  yyyy"},minor:{units:a.units.month,by:1,f:"MMMMM"}},{max:45e7,clear:{units:a.units.year,by:1},major:{units:a.units.year,by:1,f:"yyyy"},minor:{units:a.units.month,by:3,f:"Q"}},{max:6e8,clear:{units:a.units.year,by:1},major:{units:a.units.year,by:1,f:"yyyy"},minor:{units:a.units.month,by:6,f:"QQ"}},{max:85e7,clear:{units:a.units.year,by:10},major:{units:a.units.year,by:10,f:"yyyy"},minor:{units:a.units.year,by:1,f:"'yy"}},{max:Infinity,clear:{units:a.units.year,by:10},major:{units:a.units.year,by:10,f:"yyyy"},minor:{units:a.units.year,by:1,f:"'yy"}}];return{instructions:f}}function e(a,b,c,d,e,f,g,h,i){function n(a,b){m.push(a),m.push(b)}function o(a,b){l.push(1),n(a,b)}function p(a,b){l.push(2),n(a,b)}function q(a,b,c,d){l.push(3),n(a,b),n(c,d)}var j=g/2,k="#asdfadsf",l=[],m=[];totalWidth=h+i;var r=(c+d)/2-totalWidth/2,s=1,t=Math.PI*0,u=h*Math.cos(t),v=h*(1-Math.sin(t)),w=v*Math.tan(t),x=i*Math.cos(t),y=i*(1-Math.sin(t)),z=y*Math.tan(t);o(c,f),p(r,f),q(r+(u-w)*s,f+v*(1-s),r+u,f+v),q(r+u+z*s,f+v+y*s,r+u+x,f+v+y),p(d,f+v+y),a.path(l,m,e,g,k)}function f(a,b,c,d){var f=a[0],h=a[a.length-1],i;if(b){var j=g(h.w),k=g(f.w);i=j+k+(h.y-f.y);for(var l=0;l<a.length;l++){var m=a[l];e(c,d,100,600,m.c,m.y,m.w,j+h.y-m.y,k+m.y-f.y)}}return i}function g(a){return Math.max(2*a,30)}function h(){return{instructions:function(a,b,c,d,e){bands=[{y:240,w:Math.floor(c.w(14)/2)*2,c:"rgb(91,92,95)"},{y:260,w:Math.floor(c.w(14)/2)*2,c:"rgb(41,92,95)"},{y:280,w:Math.floor(c.w(14)/2)*2,c:"rgb(91,42,95)"}];var g=f(bands,!0,a,c)}}}var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.TimeModel={});var b=typeof KeyLinesRequire!="undefined"?require("./util"):this.KeyLines.Util;a.createModel=function(a,b){function l(a){var b=i.getTime()-0+k*a,c=new Date;return c.setTime(b),c}var e=c(),f=d(),g=h();e.type=function(){return"Timeline"},e.load=function(a){};var i=new Date(2011,10,4),j=new Date(2012,1,1),k=(j.getTime()-i.getTime())/500;return e.generate=function(a,b,c,d,e,h){var i=c.newToOldX(0),j=c.newToOldX(c.width()),k=l(i),m=l(j);f.instructions(a,b,100,20,0,c.width(),k,m),g.instructions(a,b,c,d,e)},e}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Combo={}),a.create=function(a){function c(b,c){var d=[],e=a.serialize().items;for(var f=0;f<e.length;f++){var g=e[f];g.type===c&&b[g.id]&&d.push(g)}return d}function d(a){var b={};for(var c=0;c<a.length;c++)b[a[c].id]=a[c];return b}function e(a){var c=[];for(var d in a)d=b.ensureId(d),c.push(a[d]);return c}function f(a){return a+Math.floor(Math.random()*1e7)}function g(a,b){var c=f(b);return a[c]?g(a):c}function h(a,b){return a.substr(0,b.length)===b}function k(a){return h(a,i)}function l(a){var b=[];if(k(a)){var c=j[a].nodes;for(var d=0;d<c.length;d++)k(c[d].id)?b=b.concat(l(c[d].id)):b.push(c[d])}return b}function m(a){var b=[];if(k(a)){var c=j[a].nodes;for(var d=0;d<c.length;d++)k(c[d].id)&&(b.push(c[d].id),b=b.concat(m(c[d].id)))}return b}function n(a,b){var c=q[a.id];if(typeof c=="undefined")return 0;var d=j[c],e=Number(a[b])-Number(d[b]);return e+n(d,b)}function o(a,b,c){var d=g(j,i);return j[d]={id:d,nodes:a,x:b,y:c},d}function p(a){var b=j[a];return delete j[a],b}function r(){var a={};for(var c in j){c=b.ensureId(c);for(var d=0;d<j[c].nodes.length;d++)a[j[c].nodes[d].id]=c}return a}function s(){q=r()}function t(a){var b;while(a)b=a,a=q[a];return b}function u(a){return a!==t(a)}function w(a){return h(a,v)}function x(){var b=f(v);return a.getItem(b)?x():b}function z(a,b,c){var d=t(a.id1),e=t(a.id2);return d===b&&e===c||d===c&&e===b}function A(c){if(w(c)){var d=a.getItem(c);if(d){var e=[];for(var f in y)f=b.ensureId(f),z(y[f],d.id1,d.id2)&&e.push(y[f]);return e}}return null}function B(){function e(a,b,c){var e=a<b?a:b,f=a>b?a:b;d[e]||(d[e]={}),d[e][f]||(d[e][f]=[]),d[e][f].push(c)}var c={};a.privateEach({type:"node"},function(a){c[a.id]={}}),a.privateEach({type:"link"},function(a){c[a.id1][a.id2]=c[a.id2][a.id1]=!0});var d={};for(var f in y){f=b.ensureId(f);var g=y[f],h=t(g.id1),i=t(g.id2);h!==i&&(c[h][i]||e(h,i,g))}var j=[];for(var l in d){l=b.ensureId(l);for(var m in d[l]){m=b.ensureId(m);if(k(l)||k(m)){var n=b.clone(d[l][m][0]);n.id1=l,n.id2=m,n.id=x(),n.off=undefined,j.push(n)}else{var o=d[l][m];for(var p=0;p<o.length;p++)j.push(o[p]),delete y[o[p].id]}}}return j}function C(a,c){if(!b.isNullOrUndefined(c.label))return c.label;var d="";for(var e=0;e<a.length;e++)b.isNullOrUndefined(a[e].t)||(d+=a[e].t,e<a.length-1&&(d+="\n"));return d}function D(a,b,c,d){var e,f=0,g=0;for(e=0;e<a.length;e++)f+=a[e].x,g+=a[e].y;f/=a.length,g/=a.length;var h=b.position==="average"?f:a[0].x,i=b.position==="average"?g:a[0].y;for(e=0;e<a.length;e++)c.push({id:a[e].id,x:h,y:i}),e>0&&d.push({id:a[e].id,x:a[e].x+b.dx,y:a[e].y+b.dy});return{x:h,y:i}}function E(a,c,d){var e=c.style?c.style:b.clone(a[0]);delete e.id,b.isNormalObject(c.style)&&(e=b.merge(e,c.style));var f={p:"ne",c:"rgb(255, 0, 0)",t:d};b.isNormalObject(c.glyph)&&(c.glyph=b.defaults(c.glyph,{p:"ne",c:null,u:null})),b.isNormalObject(c.glyph)&&(f=b.merge(f,c.glyph),!c.glyph.c&&!c.glyph.u&&(f.c="rgb(255, 0, 0)"));var g=[];return c.glyph!==null&&g.push(f),e.g=g,b.isNormalObject(c.d)&&(e.d=b.clone(c.d)),e.type="node",e}function F(a){var b=[];for(var c=0;c<a.length;c++)b.push(a[c].id);return b}function G(a){var b=[],c={},d;for(var e=0;e<a.length;e++)for(var f=0;f<a[e].ids.length;f++){d=a[e].ids[f];if(!c[d])c[d]=1,b.push(d);else throw new Error("[Combine] nodes should be only in one combo")}return b}function H(b){var c,d,e={},f=[];for(var g=0;g<b.length;g++){c=b[g];if(!e[c]){d=a.getItem(c);if(!d||d.type!=="node")throw new Error("[Combine] function must be passed valid ids");d.type==="node"&&(f.push(d),e[c]=1)}}if(f.length<2)throw new Error("[Combine] function must be passed more than one node id");return f}function I(a,c,d){var e=o(a,d.x,d.y);s();var f=l(e),g=E(a,c,f.length),h=b.merge(g,{id:e,t:C(a,c),x:d.x,y:d.y});return h}function J(c,d,e){function r(){var f=[];for(var g=0;g<c.length;g++){var h=I(j[g],c[g],n[g]);f.push(h)}a.merge(f,function(){a.privateRemoveItem(k);var c=B();a.privateMerge(c,function(){var c=F(f);d.select&&(a.selection(c),a.trigger("selectionchange")),b.isFunction(e)&&e(c)})})}var f,g,h,i,j=[];d=b.defaults(d,{animate:!0,select:!0,time:250}),c=b.ensureArray(c);for(f=0;f<c.length;f++)i=c[f],c[f]=b.defaults(i,{position:"average",dx:0,dy:0,label:null,style:null,d:null}),c[f].ids=b.ensureArray(c[f].ids),h=H(c[f].ids),j.push(h);var k;k=G(c);var l=[],m=[],n=[],o;for(f=0;f<c.length;f++)o=D(j[f],c[f],l,m),n.push(o);var p=a.graph().neighbours(k,{all:!0});for(g=0;g<p.links.length;g++){var q=p.links[g];w(q)||(y[q]=a.getItem(q))}a.trigger("prechange","combine");var s=l.length?d.time:0;a.setProperties(m,!1,function(){d.animate?a.animateProperties(l,{time:s},r):a.setProperties(l,!1,r)})}function K(c,d,e){function D(){d.select&&(a.selection(r),a.trigger("selectionchange")),b.invoke(e)}a.trigger("prechange","uncombine"),d=b.defaults(d,{animate:!0,time:250,full:!1,select:!0}),s();var f=b.ensureArray(c),g={},h,i=0,o={},q=[],r=[],t=[];for(var u=0;u<f.length;u++){h=f[u];if(k(h)){var v=a.getItem(h);v&&(i++,g[h]=a.getItem(h),d.full?(o[h]=l(h),q=q.concat(m(h))):o[h]=j[h].nodes)}}if(i===0){b.invoke(e);return}for(h in g){h=b.ensureId(h);for(var w=0;w<o[h].length;w++){var x=o[h][w];r.push(x.id),t.push({id:x.id,x:g[h].x+n(x,"x"),y:g[h].y+n(x,"y")})}}for(var y=0;y<q.length;y++)p(q[y]);for(h in g){h=b.ensureId(h);var z=o[h];for(var A=0;A<z.length;A++)z[A].x=g[h].x,z[A].y=g[h].y,a.setItem(z[A]);p(h),a.privateRemoveItem(h)}s();var C=B();a.privateMerge(C,function(){d.animate?a.animateProperties(t,{time:d.time},D):a.setProperties(t,!1,D)})}function L(a){return k(a)?{nodes:l(a),links:null}:w(a)?{nodes:null,links:A(a)}:null}function M(a){a&&(j=d(a.nodes),y=d(a.links));var c=b.clone(e(j)),f=b.clone(e(y));return{nodes:c,links:f}}var b=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,i="_combo_",j={},q={},v="_combolink_",y={},N={api:{combine:J,uncombine:K,info:L,isCombo:function(a,c){var d=b.ensureArray(a);c=b.defaults(c,{type:"all"});if(!c.type.match(/^(node|link|all)$/))throw new TypeError("opts type property should be either 'node', 'link' or 'all'");for(var e=0;e<d.length;e++){if(k(d[e])&&c.type!=="link")return!0;if(w(d[e])&&c.type!=="node")return!0}return!1}},internalUse:{preMerge:function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];d.type==="node"&&(u(d.id)||b.push(d)),d.type==="link"&&(u(d.id1)||u(d.id2)?y[d.id]=d:b.push(d))}return b},postMerge:function(b){var c=B();a.privateMerge(c,b)},preDelete:function(d){d=b.ensureArray(d);var e=b.makeIdMap(d),f=c(e,"node"),g=[];for(var h=0;h<f.length;h++)g.push(f[h].id);var i=c(e,"link"),j=a.graph().neighbours(g,{all:!0}).links,l=b.makeIdMap(j);for(var m=0;m<i.length;m++)l[i[m].id]=1;for(var n in l){n=b.ensureId(n);if(w(n)){var o=A(n);for(var q=0;q<o.length;q++)y[o[q].id]&&delete y[o[q].id]}}for(var r=0;r<f.length;r++){var t=f[r].id;k(t)&&p(t)}s()},serialize:M,loadUp:function(a){a?M(a):(j={},y={}),s()}}};return N}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Overlays={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering;a.createOverlays=function(a,c){function j(a,b){return i[a]=b?!0:!1,a}function m(){k=b.colours.ci,l=b.colours.cia}function n(a){h[a]&&h[a].apply(null,arguments)}function p(a,c,d,e,f,g,h){a.rect(c.scale(d),c.scale(e),c.scale(f),c.scale(g),b.colours.white,-1,b.colours.white,!0,h)}var d={},e={},f={},g=[],h={},i={};d.appendImageList=function(a){for(var b in i)a[b]=1};var k,l;m(),d.colorize=function(a,c,d){var e={},f,g="rgb(0,174, 234)";if(d){var h=b.colorize(a,i,c,g,d);f=h.colour,e=h.images,k=b.rgbtostring(f[0],f[1],f[2]),l=b.rgbatostring(f[0],f[1],f[2],.5)}else m();for(var j in a){var n=e[j]?e[j]:a[j].im;a[j].co=n}},d.setup=function(){o(),a.bind("click",n)},d.createDragger=function(a,b,c){return a in e?e[a](b,c):null};var o=d.reset=function(){e={},f={},g=[],h={},i={},a.unbind("click",n),wmWidth=undefined,wmHeight=undefined};d.getCursor=function(a){return a in f?f[a]:"auto"},d.generate=function(a,b,c,d,e,f,h,i){for(var j=0;j<g.length;j++)g[j].generate(a,b,c,d,e,f,h,i)},d.getWatermarkSize=function(a,b){for(var c=0;c<g.length;c++){var d=g[c];if(d.watermarkSize)return d.watermarkSize(a,b)}return null},d.addTimebar=function(a,b,c,d,e){var f="_timeBar",g={}},d.addLogo=function(a,c){var d=15,e="_logo",f={generate:function(c,f,g,h,i,j,k){c.layer(b.layers.OVERLAYS);var l=h[a].im;j||c.image(g.scale(g.width()-(l.width+d)),g.scale(d),g.scale(g.width()-d),g.scale(d+l.height),a,e)}};g.push(f),j(a)},d.remove=function(a,c,d){var e=42,f={generate:function(f,g,h,i,j,k,l){f.layer(b.layers.OVERLAYS);if(!k){var m=b.measureText(g,a,e).width,n=h.scale((h.width()-m)/2),o=h.scale((h.height()+e)/2);f.text(n+2,o+2,a,d,h.scale(e),!0,""),f.text(n,o,a,c,h.scale(e),!0,"")}}};g.push(f)},d.addTextWatermark=function(a,c,d,e,f,h,i,k){var l="_textWatermark",m={watermarkSize:function(e,f){var g,h;if(a&&f){var i=f[a].im;g=i.width,h=i.height}else c&&(g=b.measureText(e,c,d,k).width,h=d);return g?{width:g+10,height:h+10}:null},generate:function(g,j,m,n,o,p,q){g.layer(b.layers.UNDERLAYS);if(!p){if(a){var r=n[a].im;x=m.scale((m.width()-r.width)/2),y=m.scale((m.height()-r.height)/2),g.image(x,y,x+m.scale(r.width),y+m.scale(r.height),a,l);return}if(c){var s=m.scale(d),t=b.measureText(j,c,d,k).width;x=m.scale((m.width()-t)/2),y=m.scale((m.height()+d)/2);var u=Math.floor(s/4),v=Math.floor(s/8);i==="top"&&(y=s+v),i==="bottom"&&(y=m.scale(m.height())+1),h&&g.rect(x-u,y-s-v,x+t+u+v,y,h,-1,h,!0,l),g.text(x,y,c,e,s,f,l,k)}}}};g.push(m),a&&j(a)},d.addNavigation=function(c,d,i,k,l,m){function A(){return c.interactionOptions().handMode}function B(a,b){var d=a-z[q].im.height/2,e=D(d);c.setZoom(e,b)}function C(a){var b=(Math.log(a)-Math.log(k.minZoom()))/(Math.log(k.maxZoom())-Math.log(k.minZoom()));return Math.floor(x+(1-b)*(y-x))}function D(a){var b=1-(a-x)/(y-x),c=Math.exp(b*(Math.log(k.maxZoom())-Math.log(k.minZoom()))+Math.log(k.minZoom()));return c}function E(){return k.height()<300}var n=j(m+"Background.png",!0),o=j(m+"BackgroundShort.png",!0),q=j(m+"Slider.png"),r=j(m+"Hand.png"),s=j(m+"Arrow.png"),t={},u=7,v=17,w=28,x=135,y=232,z;h._zoomIn=function(){c.zoomIn(!0)},h._zoomOut=function(){c.zoomOut(!0)},h._panLeft=function(){c.panLeft(!0)},h._panRight=function(){c.panRight(!0)},h._panUp=function(){c.panUp(!0)},h._panDown=function(){c.panDown(!0)},h._fitToWindow=function(){c.fitToModel(!0)},h._toggleMode=function(){var a=c.interactionOptions();a.handMode=!a.handMode,c.interactionOptions(a)},h._scale=function(a,b,c){B(c,!0)},f._zoomIn=f._zoomOut=f._panLeft=f._panRight=f._panUp=f._panDown=f._fitToWindow=f._toggleMode=f._scale="pointer",f._slider='url("'+m+'openhand.cur"), pointer',e._slider=function(){var b=k.zoom();if(E())return null;if(a.trigger("dragstart","slider"))return;return{getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){b=k.unscale(b),B(b,!1)},endDrag:function(d,e,f,g,h){var i=a.trigger("dragend","slider");d=d&&!i,d||c.setZoom(b,!1),a.trigger("dragcomplete","slider")}}};var F={generate:function(a,c,d,e,f,g,h){a.layer(b.layers.OVERLAYS);var i=E()?o:n,j=e[i].im;if(!h){z=e;if(!g)a.image(d.scale(u),d.scale(v),d.scale(u+j.width),d.scale(v+j.height),i,"_background","co"),a.image(d.scale(26),d.scale(81),d.scale(54),d.scale(113),A()?r:s,"_toggleMode");else{var k=18;p(a,d,32,104+k,54,115+k,"_zoomIn");var l=E()?125:223;p(a,d,32,l+k,54,l+17+k,"_zoomOut"),p(a,d,16,42,32,58,"_panLeft"),p(a,d,53,42,68,58,"_panRight"),p(a,d,32,25,48,41,"_panUp"),p(a,d,32,63,48,76,"_panDown"),p(a,d,32,48,48,58,"_fitToWindow"),E()||p(a,d,36,119+k,50,220+k,"_scale"),p(a,d,27,85,49,107,"_toggleMode")}if(!E()){var m=C(d.zoom());a.image(d.scale(w),d.scale(m),d.scale(w+e[q].im.width),d.scale(m+e[q].im.height),q,"_slider")}}},createDragger:function(a,b,c,d,e){}};f[n]="wait",g.push(F)};var q,r,s;return d.addOverview=function(d,i,m,n,o,p,t,u){function C(a){var b={x1:m.newToOldX(m.scale(-a)),x2:m.newToOldX(m.scale(m.width()+a)),y1:m.newToOldY(m.scale(-a)),y2:m.newToOldY(m.scale(m.height()+a))};return{x1:B.oldToNewX(b.x1),x2:B.oldToNewX(b.x2),y1:B.oldToNewY(b.y1),y2:B.oldToNewY(b.y2)}}function L(){H+=J.x,I+=J.y,a.trigger("redraw")}function N(){M=setInterval(L,50)}function O(){M&&(clearInterval(M),M=null)}var v=j(o+"ArrowUp.png",!0),w=j(o+"ArrowDown.png",!0);u=u||100,q=u,s=t,r=n(u,u);var x=r.getContext("2d"),y=!1,z=!1,A=(new Date).getTime(),B=c.createView(a,u,u);h._overviewIcon=function(){s=!s,a.trigger("overview",s?"open":"close")},f._overviewIcon="pointer";var D=null,E=!1,F=0,G=0,H=0,I=0,J,K=2;f._overviewBox='url("'+o+'openhand.cur"), pointer';var M;e._overviewBox=function(b,c){if(a.trigger("dragstart","overview"))return;E=!0;var e=2;F=0,G=0,H=0,I=0;var f=-D.x1+e,g=u-D.x2-e,h=-D.y1+e,i=u-D.y2-e;return{getCursor:function(a,b){return"move"},dragMove:function(a,d,e,j){O(),F=a-b,G=d-c,J={x:0,y:0};var k=!1;F<f&&(F=f,J.x=K,k=!0),F>g&&(F=g,J.x=-K,k=!0),G<h&&(G=h,J.y=K,k=!0),G>i&&(G=i,J.y=-K,k=!0),k&&N()},endDrag:function(b,c,e,f,g){E=!1,O();var h=a.trigger("dragend","overview");if(b&&!h){var i=-(F-H)*m.zoom()/B.zoom(),j=-(G-I)*m.zoom()/B.zoom();d.panBy(i,j,!0)}a.trigger("dragcomplete","overview")}}};var P=b.instructionPool(),Q={generate:function(c,e,f,g,h,j,m,n){c.layer(b.layers.OVERVIEW);if(!m){if(s){c.rect(f.scale(f.width()-u-2),f.scale(f.height()-u-2),f.scale(f.width()+1),f.scale(f.height()+1),b.colours.white,Math.max(1,f.scale(3)),b.colours.white,j,"_overviewBorder1"),c.rect(f.scale(f.width()-u)-.5,f.scale(f.height()-u)-.5,f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,Math.max(1,f.scale(1)),b.colours.white,!1,"_overviewBorder2");if(i&&!j){var o=(new Date).getTime();if(y&&!E&&o<A+1e3&&z)a.trigger("redraw");else{A=(new Date).getTime(),y=!0,x.clearRect(0,0,u,u),x.fillStyle=b.colours.white,x.fillRect(0,0,u,u),d.drawBackground(x);var q=Math.max(f.width(),f.height())/2;B.reset(!1,!0);var r=C(q);B.fitExtents(r,!1,!1,undefined,undefined,undefined,!0),E&&B.panBy(H,I,!1,!0),P.reset(),i.generate(P,x,B,g,null,null,n),b.draw6(x,P,g,b.overviewLayers),z=(new Date).getTime()-A>30}}i&&(D||(D=C(0)),c.layer(b.layers.OVERVIEW),E||c.rect(f.scale(f.width()-u+D.x1),f.scale(f.height()-u+D.y1),f.scale(f.width()-u+D.x2),f.scale(f.height()-u+D.y2),k,Math.max(1,f.scale(2)),l,!0,"_overviewBox"),E&&c.rect(f.scale(f.width()-u+D.x1+F),f.scale(f.height()-u+D.y1+G),f.scale(f.width()-u+D.x2+F),f.scale(f.height()-u+D.y2+G),k,Math.max(1,f.scale(2)),b.colours.white,!1,"_overviewBoxDragging"))}var t=s?w:v,J=g[t].im;p&&(j?c.rect(f.scale(f.width()-J.width*2),f.scale(f.height()-J.height*2),f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,-1,b.colours.white,!0,"_overviewIcon"):(c.rect(f.scale(f.width()-J.width)-.5,f.scale(f.height()-J.height)-.5,f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,Math.max(1,f.scale(1)),b.colours.white,!0,"_overviewIconRect"),c.image(f.scale(f.width()-J.width),f.scale(f.height()-J.height),f.scale(f.width()),f.scale(f.height()),t,"_overviewIcon","co")))}}};g.push(Q)},d.drawOverviewContent=function(a,b){if(s&&r){var c=b.scale(q);a.isFlash?a.drawImageDirect(r,0,0,q,q,b.scale(b.width()-q),b.scale(b.height()-q),c,c):a.drawImage(r,0,0,c,c,b.scale(b.width()-q),b.scale(b.height()-q),c,c)}},d}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Graph={}),a.create=function(a,b){function z(a){a.direction=a.direction||"any";if(!a.direction.match(/^(any|from|to)$/))throw new TypeError("opts direction property should be either 'from', 'to' or 'any'")}function A(a){a.normalization=a.normalization||"any";if(!a.normalization.match(/^(chart|component|unnormalized)$/))throw new TypeError("opts normalization property should be either 'component', 'chart' or 'unnormalized'")}function B(a){return k(a,function(b,c,d,e){if(v(d,e,c,a)<=0)throw new Error("Link Weight must be Positive")}),{direction:a.direction,value:a.value,weights:F(a)}}function C(a){return a.normalization.match(/component/)?"component":a.normalization.match(/chart/)?"chart":"unnormalized"}function D(a){return z(a)||B(a)}function E(a){a.all=!!a.all}function F(a){return!!a.weights}function G(a){var b=0;return l(a,function(a,c){b++}),b}var c=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,d={},e={},f={},g=b;d.privateSetProperties=function(a,b){e=a,f=b};var h={},i=[],j={},k=function(a,b){var d=a.all;for(var e in f){e=c.ensureId(e);var g=f[e];(a.all||!g.hi)&&b(g,g.id,g.id1,g.id2)}},l=function(a,b){var d=a.all;for(var f in e){f=c.ensureId(f);var g=e[f];(a.all||!g.hi)&&b(g,g.id)}},m=function(a,b,c,d){function e(){var b=[];return l(a,function(a){b.push(a)}),b}var f=e(),h=f.length,i=-1,j=(new Date).getTime(),k=j,m=700,n=function(){i++;if(i<h)c(f[i],q);else{o(1),d();return}},o=function(a){g&&g.trigger("progress",b,a)},p=function(){return j=(new Date).getTime(),j-k>m?(k=(new Date).getTime(),!0):!1},q=function(){p()?(o(i/h),setTimeout(n,0)):n()};o(0),q()},n=function(a){var b=[],d={};k(a,function(a,b,c,e){var f=c<e?c:e,g=c<e?e:c;d[f]||(d[f]={}),d[f][g]||(d[f][g]=[]),d[f][g].push(a.id)});for(var e in d){e=c.ensureId(e);for(var f in d[e])f=c.ensureId(f),b.push(d[e][f])}return b};d.adjacent=function(a,b){return j[a]&&j[a][b]?j[a][b].length:0};var o=d.neighbours=function(a,b){var d=[],g={},h=c.makeIdMap(a);b=c.defaults(b,{all:!1}),E(b);for(var i in h){i=c.ensureId(i);if(!e[i]&&!f[i])throw new Error("neighbours error: ids must be present in the graph")}return k(b,function(a,b,c,e){h[c]&&(d.push(a.id),g[e]=1),h[e]&&(d.push(a.id),g[c]=1),h[a.id]&&(g[c]=1,g[e]=1)}),{nodes:c.flattenMap(g),links:d}},p=d.components=function(a){var b=[],d=0,e=[],f,g;a=c.defaults(a,{all:!1}),E(a),q(a);for(f in h)if(!h[f].hasOwnProperty("c")){b.push(f+"");while(b.length>0){var j=b.shift();if(!h[j].hasOwnProperty("c")){h[j].c=d;for(g=0;g<i.length;g++)i[g].id1===j&&(i[g].c=d,b.push(i[g].id2)),i[g].id2===j&&(i[g].c=d,b.push(i[g].id1))}}e.push({nodes:[],links:[]}),d++}for(f in h)e[h[f].c].nodes.push(f+"");for(g=0;g<i.length;g++)e[i[g].c].links=e[i[g].c].links.concat(i[g].ids);return e},q=d.reset=function(a){var b=n(a),c,d=0;h={},i=[],l(a,function(a,b){d++,h[b]={x:a.x,y:a.y},j[b]={}});for(var e=0;e<b.length;e++)c=f[b[e][0]],i.push({id:c.id,id1:c.id1,id2:c.id2,ids:b[e]}),c.id1!==c.id2&&(j[c.id1][c.id2]=j[c.id2][c.id1]=b[e])},r=d.shortestPaths=function(a,b,d){function j(a){var b=[];for(var c=0;c<a.length;c++)g[a[c].id]&&(b=b.concat(g[a[c].id]));return b}if(!e[a]||!e[b])throw new Error("shortestPaths error: ids must be present in the graph");d=c.defaults(d,{all:!1}),D(d),E(d);var f=y(a,d),g=f.previous;if(f.distance[b]===Infinity)return Infinity;var h=[],i=b;while(g[i])h.unshift(i),i=g[i][0].id;h.unshift(i);var k={};k[b]=1;var l=[];l.push({id:b});var m=j(l);while(m.length>0){for(var n=0;n<m.length;n++){k[m[n].id]=1;for(var o=0;o<m[n].links.length;o++)k[m[n].links[o]]=1}m=j(m)}return{one:h,items:c.flattenMap(k),distance:f.distance[b]}},s=d.distances=function(a,b){if(!e[a])throw new Error("distances error: id(s) must be present in the graph");b=b||{},D(b),E(b);var c=y(a,b),d={};for(var f in c.distance){var g=c.distance[f];isFinite(g)&&(d[f]=g)}return d},t=function(a,b,c){var d=j[a][b],e=Infinity,f=w(c),g;if(d)for(var h=0;h<d.length;h++){var i=f(a,b,d[h],c);isNaN(i)||(i<e&&(g=[],e=i),i===e&&e!==Infinity&&g.push(d[h]))}return{value:e,links:g}},u=function(a,b){return f[a].a2&&f[a].id2===b||f[a].a1&&f[a].id1===b},v=function(a,b,c,d){var e=NaN,g=!0;return d.direction!=="any"&&(g=d.direction==="from"&&u(c,b)||d.direction==="to"&&u(c,a)),g&&(d.value?f[c].d&&(e=Number(f[c].d[d.value])):e=1),e},w=function(a){return F(a)?x:v},x=function(a,b,c,d){var e=v(a,b,c,d);return isNaN(e)?e:1/e},y=function(a,b){function g(){var a,b=Infinity;for(var c=0;c<f.length;c++){var e=d[f[c]];e<=b&&(a=c,b=e)}return a}function h(a,b,c){e[a]||(e[a]=[]),e[a].push({id:b,links:c})}var d={},e={},f=[];q(b),l(b,function(a,b){d[b]=Infinity,e[b]=undefined,f.push(b)}),d[a]=0;while(f.length>0){var i=g(),k=f[i];if(d[k]===Infinity)break;f.splice(i,1);for(var m in j[k]){m=c.ensureId(m);var n=t(k,m,b),o=d[k]+n.value;o<d[m]?(d[m]=o,h(m,k,n.links)):o===d[m]&&h(m,k,n.links)}}return{distance:d,previous:e}},H=d.degrees=function(a){a=c.defaults(a,{multi:!0,all:!1}),D(a),E(a),q(a);var b={};return l(a,function(d,e){b[e]=0;for(var f in j[e]){f=c.ensureId(f);for(var g=0;g<j[e][f].length;g++){var h=v(e,f,j[e][f][g],a);if(!isNaN(h)){b[e]+=h;if(!a.multi)break}}}}),b},I=d.betweenness=function(a,b){function d(a,b){return K[a]-K[b]}function e(a){return a.sort(d),a.shift()}function f(a,b){a.sort(d);if(c.contains(a,b))return;a.push(b)}function g(a,b){var c=t(a,b,y).value;return isFinite(c)?c:!s()&&!isFinite(c)?1:Infinity}function h(a){return a.length>0}function i(){B.length=0,G.length=0,l(a,function(a,b){for(var c=0;c<T.length;c++)n(T[c].dict,b,T[c].value)})}function k(a,b,c){l(a,function(a,d){n(b,d,c)})}function n(a,b,d){c.isArray(d)&&h(d)&&a[b]?a[b].length=0:a[b]=c.clone(d)}function o(){var b,c,d=p(a),e,f={};for(b=0;b<d.length;b++){e=d[b];for(c=0;c<e.nodes.length;c++)f[e.nodes[c]]=e.nodes.length}return f}function r(){return!c.isNullOrUndefined(a.value)}function s(){return!!a.directed}function u(){return a.endpoints}a=c.defaults(a,{value:undefined,directed:!1,normalization:"component",endpoints:!1,weights:!1,all:!1}),A(a),E(a);var v=r()||s()?"dijkstra":"regular",w=u()?"endpoints":"regular",x=C(a),y={direction:s()?"from":"any",value:a.value,weights:F(a),all:a.all};D(a);var z={},B=[],G=[],H={},I={},J={},K={},L,M,N=a.normalization,O,P,Q,R=0,S,T=[{dict:I,value:0},{dict:K,value:Infinity},{dict:H,value:[]},{dict:J,value:0}],U={regular:function(a){I[a]=1,K[a]=0,B.push(a);while(h(B)){L=B.shift(),G.push(L);for(var b in j[L])b=c.ensureId(b),isFinite(K[b])||(K[b]=K[L]+1,B.push(b)),K[b]===K[L]+1&&(I[b]+=I[L],H[b].push(L))}},dijkstra:function(a,b){I[a]=1,K[a]=0,B.push(a);while(h(B)){L=e(B),G.push(L);for(var d in j[L])d=c.ensureId(d),K[d]>K[L]+g(L,d)&&(K[d]=K[L]+g(L,d),f(B,d),I[d]=0,H[d]=[]),K[d]===K[L]+g(L,d)&&(I[d]+=I[L],H[d].push(L))}}},V={regular:function(a){while(h(G)){M=G.pop(),Q=(1+J[M])/I[M];for(P=0;P<H[M].length;P++)L=H[M][P],J[L]+=I[L]*Q;M!==a&&(z[M]+=J[M])}},endpoints:function(a){z[a]+=G.length-1;while(h(G)){M=G.pop(),Q=(1+J[M])/I[M];for(P=0;P<H[M].length;P++)L=H[M][P],J[L]+=I[L]*Q;M!==a&&(z[M]+=J[M]+1)}}},W={chart:function(){if(R>2){O=1/((R-1)*(R-2));for(var a in z)a=c.ensureId(a),z[a]*=O}},component:function(){S=o();for(var a in z)a=c.ensureId(a),S[a]>2&&(O=1/((S[a]-1)*(S[a]-2)),z[a]*=O)},unnormalized:function(){if(!s()){O=.5;for(var a in z)a=c.ensureId(a),z[a]*=O}}},X=function(){$(),c.isFunction(b)&&b(z)},Y=U[v]||U.regular,Z=V[w]||V.regular,$=W[x]||W.chart;q(a),l(a,function(a,b){R++}),k(a,z,0);var _=function(a,b){i(),Y(a.id),Z(a.id),b()};m(a,"betweenness",_,X)},J=d.closeness=function(a,b){function d(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=isFinite(b[e])?1:0;return d}function e(a){for(var b in a){b=c.ensureId(b);if(a.hasOwnProperty(b))return!1}return!0}function g(a){return!c.isNullOrUndefined(a)}function h(a){return!f[a].a1&&!f[a].a2}function i(a){var b={},d=0,f={},h={};h[a]=1;while(!e(h)){f=h,h={};for(var i in f){i=c.ensureId(i);if(!g(b[i])){b[i]=d;for(var k in j[i])k=c.ensureId(k),h[k]=1}}d+=1}return b}function k(){return a.direction!=="any"}function l(){a.mode=a.mode||"auto";if(!a.mode.match(/^(connected|disconnected|auto)$/))throw new TypeError("Option mode property should be either 'connected', 'disconnected' or 'auto'")}function n(){return l(),a.mode==="auto"?u():a.mode}function o(){return!c.isNullOrUndefined(a.value)}function r(){return C(a).match(/chart/)}function t(){return C(a).match(/component/)}function u(){var b="disconnected",c=p(a);if(c.length===1){b="connected";if(k())for(var d=0;d<c[0].links.length;d++)if(h(c[0].links[d]))return"disconnected"}return b}a=c.defaults(a,{direction:"any",value:undefined,normalization:"component",mode:"auto",weights:!1,all:!1});var v=D(a);A(a),E(a),v.all=a.all;var w=o()||k()?"dijkstra":"regular",x,y=0,z={},B,F,H,I=n(),J,K={regular:function(a){return i(a)},dijkstra:function(a,b){return s(a,b)}},L={connected:function(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=isFinite(b[e])?b[e]:0;return d?1/d:0},disconnected:function(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=a!==e?1/b[e]:0;return d}},M=function(){c.isFunction(b)&&b(z)};B=K[w]||K.regular,F=L[I],q(a),y=G(a),z={};var N=function(a,b){H=B(a.id,v),x=d(a.id,H),z[a.id]=F(a.id,H),y>1&&(r()?J=Math.pow(x-1,2)/(y-1):t()?J=x-1:J=1,z[a.id]*=J),b()};m(a,"closeness",N,M)},K=d.bipartite=function(a){function b(a,b,c){return d[a]||(d[a]=b),d[a]===c?!1:!0}var d={},e=!0,f,g,h="r",i,j="b",k=[],m=[];a=c.defaults(a,{all:!1}),E(a),l(a,function(c,d){if(e){e=b(d,h,j),f=o(d,a).nodes;for(g=0;e&&g<f.length;g++)e=b(f[g],j,h);i=h,h=j,j=i}});if(!e)return[];for(var n in d)n=c.ensureId(n),d[n]==="r"?k.push(n):m.push(n);return[k,m]},L=d.kCores=function(a){function d(a){var b=0;for(var d in a)d=c.ensureId(d),b=Math.max(b,a[d]);return b}var b=function(){var b,d,e,f,g,h,i,k,m,n,o={},p={},q=[],r=[],s;d=0,o=H({multi:!1,all:a.all});for(var t in o)t=c.ensureId(t),d=Math.max(d,o[t]);s=c.flattenMap(o).length;for(b=0;b<d+1;b++)r[b]=0;l(a,function(a,b){r[o[b]]++}),g=1;for(b=0;b<d+1;b++)h=r[b],r[b]=g,g+=h;l(a,function(a,b){p[b]=r[o[b]],q[p[b]]=b,r[o[b]]++});for(b=d;b>1;b--)r[b]=r[b-1];r[0]=1;for(f=0;f<s;f++){e=q[f];for(var u in j[e])u=c.ensureId(u),o[u]>o[e]&&(k=o[u],m=p[u],n=r[k],i=q[n],u!==i&&(p[u]=n,q[m]=i,p[i]=m,q[n]=u),r[k]++,o[u]--)}return o};a=c.defaults(a,{all:!1}),E(a),q(a);var e=b();return{maximumK:d(e),values:e}};return d}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Controller={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering;a.createController=function(c,d,e){function s(){var a=J();return typeof a.isActuallyTheFlashLoader=="undefined"}function t(a,b){for(var c in a)u(a[c].im)&&(a[c].im=a[b])}function u(a){return typeof a.naturalWidth!="undefined"&&a.naturalWidth===0}function v(){return{icon:!0,shown:!1,size:100}}function z(){e.setup();var c=w.watermark;c&&e.addTextWatermark(c.u?o+c.u:undefined,c.t,c.fs||80,c.fc||b.colours.lightgrey,c.fb,c.fbc,c.a,c.ff?c.ff:w.fontFamily),w.navigation&&e.addNavigation(h,m,k,j,b,I),w.overview&&e.addOverview(h,m,j,G,I,w.overview.icon,w.overview.shown,w.overview.size),w.logo&&e.addLogo(o+w.logo),a.e&&e.remove(K(n,P),K(n,Q),K(n,B))}function C(a){for(var c=0;c<a.length;c++)for(var d in a[c]){var e=a[c][d];d!=="id"&&typeof e=="string"&&(a[c][d]=b.hsla(e))}}function D(a,c,d){if(typeof a=="number")return a+d*(c-a);if(f.isArray(a)){var e;return Math.abs(a[0]-c[0])>.5?(a[0]<c[0]?e=D(1+a[0],c[0],d):e=D(a[0],1+c[0],d),e-=Math.floor(e)):e=D(a[0],c[0],d),b.fromhsla([e,D(a[1],c[1],d),D(a[2],c[2],d),D(a[3],c[3],d)])}return c}function K(a,b){var c="";for(var d=0;d<b.length;d++)c+=String.fromCharCode(a.charCodeAt(d)+b[d]);return c}function R(a,b){return function(){var c=(new Date).getTime(),d=a.apply(this,arguments),e=(new Date).getTime();return console.log("fn "+b+" = "+(e-c)+"ms"),d}}function Z(){var a=1200,b=0;return{animate:function(c){return b+=c,Y=Math.floor(8*(1-b%a/a)),W}}}function $(){if(W){U.reset([b.layers.WAIT]),U.layer(b.layers.WAIT);var a=j.scale(j.width()/2),c=j.scale(j.height()/2),d=j.scale(30);for(var e=0;e<8;e++){var f=e*Math.PI/4,g=a+d*Math.cos(f),h=c+d*Math.sin(f),i=.2+.8*((e+Y)%8)/8;U.circle(g,h,j.scale(10),b.colours.white,-1,"rgba(145, 146, 149, "+i+")",!0)}}}function ba(a){k.hasOwnProperty("drawImageDirectAlpha")?k.drawImageDirectAlpha(S,0,0,S.width,S.height,0,0,S.width,S.height,a):(k.globalAlpha=a,k.drawImage(S,0,0,j.width(),j.height(),0,0,j.width(),j.height()),k.globalAlpha=1)}function bc(a){U.reset(),m.generate(U,k,j,i,V,undefined,o),bb=m.getResizePrimitive(),bd(a),e.generate(U,k,j,i,E,!1,a,o),$()}function bd(a){a||E&&E.generate&&(U.layer(b.layers.DRAGGERS),E.generate(U))}function be(a,c){var d=S.getContext("2d");b.clear(d),b.draw6(d,U,i,a),ba(c)}function bf(a){b.draw6(a,U,i,b.topLayers),e.drawOverviewContent(a,j),b.draw6(a,U,i,[b.layers.OVERVIEW])}function bg(a){var c=S.getContext("2d");b.clear(c),bf(c),ba(a)}function bh(){b.clear(k),_(k),W?(be([b.layers.UNDERLAYS],.5),be(b.ghostLayers,T/2),bg(.5),b.draw6(k,U,i,[b.layers.WAIT])):(b.draw6(k,U,i,[b.layers.UNDERLAYS]),be(b.ghostLayers,T),bf(k))}function bj(){var a=[];if(bS)for(var c=0;c<bS.length;c++)a.push({p:b.primitives.circle,x:bS[c].x,y:bS[c].y,r:20,bc:b.colours.touch,bw:-1,fc:b.colours.touch,fi:!0});return a}function bp(a,b,c){a!==bn&&(bo&&clearTimeout(bo),bo=setTimeout(function(){d.trigger("hover",f.rawId(a),bu,bv,f.subId(a))},y.hover)),bn=a}function bt(a,b){if(E.scrollable){var c=j.maybeScroll(a,b);N(c)}}function bC(a,b,c,d,e){E&&E.endDrag(a,b,c,d,e),E=null,F("auto"),O()}function bM(){bK&&(clearTimeout(bK),bK=null)}function bT(){bN&&(clearTimeout(bN),bN=null)}var f=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,g=typeof KeyLinesRequire!="undefined"?require("./combo"):KeyLines.Combo,h={},i=null,j=null,k=null,l=null,m=null;h.combo=g.create(c);var n="Cambridge Intelligence";h.wait=function(a){return typeof a!="undefined"&&a!==W&&(W=a,a&&N(Z())),W};var o="";h.imageBasePath=function(a){return a&&(o=a),o},h.imageList=function(a){return a&&(i=a),i},h.setCanvas=function(a){k=a},h.setView=function(a){j=a},h.setShadowCanvas=function(a){l=a},h.setModel=function(a,b){m=a,x()};var p=0,q=null,r=h.afterChange=function(a,c){if(c)z(),O(),f.invoke(a);else{z();var d=m.imageList(o);e.appendImageList(d);var g=s();if(g){var h=I+"Missing.png";d[h]=1}i&&(q=i,i=null),q=q||{};var j={};for(var k in d)q[k]||(j[k]=1);(function(c){b.imageLoader(J,H,j,function(d,j){if(c===p){i=q;for(var k in j)i[k]={im:j[k]};g&&t(i,h),e.colorize(i,G,w.controlColour),b.circularize(i,i,G),O(),f.invoke(a)}})})(++p)}},w={watermark:{fb:!0},overview:v(),navigation:!0},x=function(){m.editColour(w.selectionColour),m.fontFamily(w.fontFamily)};h.displayOptions=function(a,b,c){if(a){a=a||{};for(var d in a)w[d]=a[d],d==="overview"&&(a[d]===!0&&(w[d]=v()),a[d]===!1&&(w[d]=v(),w[d].icon=!1,w[d].shown=!1));x(),m.fontFamily(w.fontFamily),r(b,c)}return f.clone(w)};var y={handMode:!1,hover:1e3};h.interactionOptions=function(a){return f.merge(y,a),f.clone(y)},h.watermarkSize=function(){return e.getWatermarkSize(k,i)},h.load=function(a){i=null,m.load(a),h.combo.internalUse.loadUp(a.combos)},h.merge=function(a){d.trigger("prechange","merge");var b=h.combo.internalUse.preMerge(a);return m.merge(b)},h.appendCombos=function(a){a.combos=h.combo.internalUse.serialize()},h.postMerge=function(a){h.combo.internalUse.postMerge(a)};var A=h.removeItem=function(a){h.combo.internalUse.preDelete(a),m.removeItem(a)};h.setProperties=function(a,b){return d.trigger("prechange","properties"),m.setProperties(a,b)},h.setViewSettings=function(a,b,c,d){N(j.fromSettingsDirect(a,b,c,d))};var B=[47,6,-11,-58,-64,-52,-48,-59,-51,21,-22,-66,-66,-48,-58,-67];h.animateProperties=function(a,b,c){function i(){var a=[];for(var b=0;b<e.length;b++){var c=m.getByID(e[b].id),d={};for(var f in e[b])if(f!=="id"){var g=c[f];typeof g=="undefined"&&(g=m.defaultValueFor(f)),typeof g!="undefined"&&(d[f]=g)}a.push(d)}return a}d.trigger("prechange","properties");var e=[];for(var g=0;g<a.length;g++){var h=m.getByID(a[g].id);h&&e.push(a[g])}C(e);var j=b.time,k=d.linearEasing;b.easing==="cubic"&&(k=d.cubicEasing);var l=j,n=!0,o,p={animate:function(a){n&&(o=i(),C(o),n=!1),l-=a;var d=k(Math.max(0,Math.min(1,(j-l)/j))),g=l>0,h=[];for(var p=0;p<e.length;p++){var q={id:e[p].id};for(var r in e[p])r!=="id"&&(q[r]=D(o[p][r],e[p][r],d));h.push(q)}m.applyChanges(h);if(!g)f.invoke(c);else if(b.cb)try{b.cb.call(this,d,j-l)}catch(s){}return g}};N(p,!0)};var E=null,F=function(a){};h.setCursorFn=function(a){F=a};var G=function(){};h.setCreateCanvasFn=function(a){G=a};var H="";h.setPath=function(a){H=a};var I;h.assetPath=function(a){return a&&(I=a),I};var J=function(){};h.setImageGenFn=function(a){J=a};var L=[],M=[],N=h.pushAnimation=function(a,b){a&&(b?M.push(a):L.push(a),O())};h.cancelAnimation=function(){L=[],M=[],O()},h.animate=function(a){var b=!1;if(L.length>0){var c=[];for(var d=0;d<L.length;d++)L[d].animate(a)&&c.push(L[d]);L=c,b=!0}L.length===0&&M.length>0&&(L.push(M.shift()),b=!0);var e=b$?b$:E;return e&&e.animate&&(e.animate(a),b=!0),m&&(b=b||m.animated()),b};var O=h.render=function(){d.trigger("redraw")};h.ping=function(a,b){};var P=[8,4,12,-22,-9,5,1,12,-69,37,45,-13,-8,16,-11,8,0,8,9,-78,-67],Q=[47,6,-11,-58,-64,-57,-48,-59,-51,19,-16,-66,-66,-48,-58,-67],S=null;h.makeGhostCanvas=function(a,b){S=G(a,b)};var T=.5;h.setGhostAlpha=function(a){T=a},h.hide=function(a,b,c){if(a.length===0){f.invoke(c);return}var d=b;T=1,m.ghost(a);var e={animate:function(e){d-=e;var g=Math.max(0,Math.min(1,(b-d)/b));T=1-g;var h=d>0;return h||(m.resurrect(a,!0),T=.5,f.invoke(c)),h}};N(e,!0)},h.show=function(a,b,c,d){if(a.length===0){f.invoke(d);return}var e=c;T=0,m.ghost(a);var g={animate:function(b){e-=b;var g=Math.max(0,Math.min(1,(c-e)/c));T=g;var h=e>0;return h||(m.resurrect(a,!0),T=.5,f.invoke(d)),h}};N(g,b)};var U=b.instructionPool(),V=b.pool(),W=!1,X=b.instructionPool(),Y=3,_=h.drawBackground=function(a){w.gradient&&b.backgroundGradient(a,w.gradient.stops)},bb,bi=h.draw=function(a){i&&(bc(a),bh())};h.measureText=function(a,c,d,e){return b.measureText(k,a,c,d,e)};var bk=function(){function d(){return Math.floor(Math.random()*255)}var a={},c={},e=function(a){var c=b.rgbtostring(d(),d(),d());return c in a?e(a):c};return{getColour:function(b){if(b in a)return a[b];var d=e(c);return a[b]=d,c[d]=b,d},getId:function(a){return c[a]?c[a]:null}}}(),bl=h.drawoffscreen=function(){if(i&&!W){b.clear(l),U.reset([b.layers.OVERLAYS]),e.generate(U,l,j,i,E,!0,!1,o);var a;E&&E.excludeHit&&(a=E.excludeHit()),b.drawShadowCanvas(l,U,G,i,!0,bk,a)}};h.afterDraw=function(){E&&E.mouseMoved&&E.mouseMoved()&&E.afterDraw(bm(bu,bv),bu,bv)};var bm=h.hittest=function(a,c){var d=l.getImageData(Math.floor(a),Math.floor(c),1,1).data,e=b.rgbtostring(d[0],d[1],d[2]),f=bk.getId(e);return f},bn=null,bo,bq=h.resetState=function(){E=null},br=h.startDragger=function(a,b,c,d){if(!m)return;c=j.oldToNewX(c),d=j.oldToNewY(d),E=m.startDragger(h,k,j,a,c,d,b),E&&a&&(cursor=E.getCursor(c,d),F(cursor))},bs=h.mousedown=function(a,b,c,g,i){if(!m)return;var l,n;if(E)bC(!0,b,c,g,i);else{l=bm(b,c);var o=d.trigger("mousedown",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l));if(m.getByID(l)||!l){var p=!1;a===0?p=!m.isSelected(l)||g||!l:p=!l||!m.isSelected(l),o&&(p=!1),p&&m.setSelection(l,g,i),a===0&&(E=m.createDragger(U,V,h,k,j,l,b,c,y,g,i,bb),E&&l&&(n=E.getCursor(b,c),F(n))),O(),a===2?d.trigger("contextmenu",f.rawId(l),j.unscale(b),j.unscale(c),f.subId(l)):d.trigger("click",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l))}else{a===0&&(E=e.createDragger(l,b,c),E&&l&&(n=E.getCursor(b,c),F(n)));if(a===0||a===1)d.trigger("click",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l)),O()}}},bu,bv,bw,bx=h.mousemove=function(a,b,c,d,f){bu=a,bv=b;var g="auto";if(E&&!f)E.mouseMoved&&E.mouseMoved(!0),bt(a,b),E.dragMove(a,b,c,d),g=E.getCursor(a,b),O();else if(m){var h=m?bm(a,b):null;m.getByID(h)||!h?(bp(h),h&&(g=m.getCursor(h,I))):g=e.getCursor(h)}bw!==g&&!f&&(F(g),bw=g)},by=h.mouseup=function(a,b,c,d){E&&bC(!0,a,b,c,d)},bz=h.mouseleave=function(){!E};h.dblclick=function(a,b,c,e){!bn&&j&&(d.trigger("dblclick",f.rawId(bn),j.unscale(a),j.unscale(b),f.subId(bn)),bF(!0)),bn&&m.getByID(bn)&&d.trigger("dblclick",f.rawId(bn),j.unscale(a),j.unscale(b),f.subId(bn))};var bA,bB=h.mousewheel=function(a,b,c){if(j){var d=(new Date).getTime();if(bA&&d-bA<100)return;bA=d,N(j.wheelToPosition(a,b,c))}},bD=h.keyup=function(a){a===27&&bC(!1)},bE=h.keydown=function(a,b,c){if(!m)return;if(m.hasSelection()){var e=0,f=0,g=20;switch(a){case 37:e=-g;break;case 38:f=-g;break;case 39:e=g;break;case 40:f=g}if(e!==0||f!==0)return d.trigger("prechange","move"),m.moveSelection(e,f),O(),!0;if(a===65&&b)return m.selectAll(),O(),!0;if(a===46){var h=d.trigger("delete");if(!h){d.trigger("prechange","delete");var i=m.selectionPlusDummyNodes();A(i)}return O(),!0}a===113&&d.trigger("edit",m.doSelection())}return!1};h.panBy=function(a,b,c,d,e){N(j.panBy(a,b,c,!1,d,e)),O()},h.panLeft=function(a,b,c){N(j.panLeft(a,b,c)),O()},h.panRight=function(a,b,c){N(j.panRight(a,b,c)),O()},h.panDown=function(a,b,c){N(j.panDown(a,b,c)),O()},h.panUp=function(a,b,c){N(j.panUp(a,b,c)),O()};var bF=h.zoomIn=function(a,b,c){N(j.zoomIn(a,b,c)),O()},bG=h.zoomOut=function(a,b,c){N(j.zoomOut(a,b,c)),O()};h.setZoom=function(a,b,c,d){N(j.setZoom(a,b,c,d)),O()},h.modelExtents=function(){return j.modelExtents(m,k,i,b,o)},h.fitToModel=function(a,c,d){i&&m&&(N(j.fitToModel(m,k,i,b,a,c,d,o)),O())},h.fitToSelection=function(a,c,d){i&&m&&(N(j.fitToSelection(m,k,i,b,a,c,d,o)),O())};var bH=h.extractStructure=function(a,b){var c=a!=="radial";return b=f.defaults(b,{fixed:[]}),m.extractStructure(k,b.fixed,c)},bI=function(a,b){var c=a;return{animate:function(a){c-=a;var d=c<0;return d&&f.invoke(b),!d}}},bJ=h.finishLayout=function(a,b,c,d){var e,f;if(a){var g=Math.max(0,Math.min(b.ms||700,2e3)),h=a.extents;e=m.makeAnimator(a.vertices,g),f=j.fitWorldExtents(a.extents,!0,!0,!0,!0,g,d),b.animate?(N(e),b.fit?N(f):h&&N(bI(g,d))):(m.applyVertices(a.vertices),h&&(b.fit?j.fitWorldExtents(a.extents,!1,!0,!0,!0,0,d):N(bI(g,d))),O())}};h.layout=function(a,b,c,e){function f(a,b,c){bJ(a,b,c,e)}if(m){b=b||{};var g=null,h=bH(a,b);m.layout(a,d,h,b,c,f)}};var bK,bL,bN,bO,bP,bQ,bR,bS;h.touchstart=function(a,b){bS=a,a.length===2&&(bY=(a[0].x+a[1].x)/2,bZ=(a[0].y+a[1].y)/2,bW=bY,bX=bZ);if(a.length===1){bO=a[0].x,bP=a[0].y,bR=a[0].id;var c=bm(bO,bP);bK?c!==bQ?bM():bL=!0:(bL=!1,bK=setTimeout(bM,600)),bQ=c,bN=setTimeout(function(){bT(),E&&bC(!1),d.trigger("contextmenu",f.rawId(bQ),j.unscale(bO),j.unscale(bP),f.subId(bQ))},600);if(m.getByID(bQ)||!bQ){var g=d.trigger("touchdown",f.rawId(bQ),j.unscale(bO),j.unscale(bP),f.subId(bQ));g||(bQ?m.isSelected(bQ)||m.setSelection(bQ,!1,!1):m.setSelection(null,!1,!1)),E=m.createDragger(U,V,h,k,j,bQ,bO,bP,y,undefined,undefined,bb),O()}else E=e.createDragger(bQ,bO,bP)}};var bU,bV,bW,bX;h.touchmove=function(a,b){bS=a,a.length>=2&&(bW=(a[0].x+a[1].x)/2,bX=(a[0].y+a[1].y)/2);for(var c=0;c<a.length;c++)bR===a[c].id&&(bU=a[c].x,bV=a[c].y);if(bN){var d=(bU-bO)*(bU-bO)+(bV-bP)*(bV-bP);d>100&&bT()}b$||E&&bR===a[0].id&&a.length===1&&(bt(a[0].x,a[0].y),E.dragMove(a[0].x,a[0].y,!1,!1),O())},h.touchend=function(a,b){bS=a,O(),bN&&(bT(),d.trigger("click",f.rawId(bQ),j.unscale(bO),j.unscale(bP),0,f.subId(bQ)));if(bK&&bL){bM();var c=d.trigger("dblclick",f.rawId(bQ),j.unscale(bO),j.unscale(bP),f.subId(bQ));c||bQ||bF(!0)}if(!b$&&E){var e=-1;for(var g=0;g<b.length;g++)b[g].id===bR&&(e=g);if(e>-1&&a.length===0)bC(!0,b[e].x,b[e].y,!1,!1);else if(a.length>0){bO=a[0].x,bP=a[0].y,bR=a[0].id,bQ=bm(bO,bP);if(m.getByID(bQ)||!bQ)m.setSelection(bQ,!1,!1),E=m.createDragger(U,V,h,k,j,bQ,bO,bP,y,undefined,undefined,bb)}}},h.touchcancel=function(a,b){bT(),E&&bC(!1)};var bY,bZ,b$;return h.gesturestart=function(){},h.gesturechange=function(a,b){bT(),b$||(b$=m.createGestureDragger(j,bY,bZ)),b$.dragMove(a,b,bW,bX),O()},h.gestureend=function(a,b){b$&&(b$.endDrag(!0,a,b,bW,bX),!E),b$=null},h}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Model={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=typeof KeyLinesRequire!="undefined"?require("./graph"):this.KeyLines.Graph;a.createModel=function(a,d){function m(a){return Math.abs(a)<1e-5}function n(a,b,c,d,e,f){return{x:((e-c)*Math.cos(b)-(f-d)*Math.sin(b))/a,y:((e-c)*Math.sin(b)+(f-d)*Math.cos(b))/a}}function o(a,b,c,d,e,f,g,h,i){var j=n(b,-c,d,e,f,g),k=n(b,-c,d,e,h,i);a/=b;if(j.y>a&&k.y>a||j.y<-a&&k.y<-a)return NaN;if(m(k.y-j.y))return Math.max(j.x,k.x);var l=j.y>k.y?j:k,o=j.y>k.y?k:j,p;a<l.y?p=l.x-(l.y-a)*(l.x-o.x)/(l.y-o.y):p=l.x;var q;return o.y<-a?q=o.x-(o.y- -a)*(o.x-l.x)/(o.y-l.y):q=o.x,Math.max(p,q)}function p(a,b,c,d,e,f){var g=-Infinity;for(var h=0;h<f.length;h++){var i=(h+1)%f.length,j=o(a,b,c,d,e,f[h].x,f[h].y,f[i].x,f[i].y);isNaN(j)||(g=Math.max(g,j))}return g}function q(a,b,c,d,e,f){return p(a,b,c,d,e,[{x:f.x1,y:f.y1},{x:f.x2,y:f.y1},{x:f.x2,y:f.y2},{x:f.x1,y:f.y2}])}function r(a,b,c,d,e,f){var g=-Infinity;for(var h=0;h<f.length;h++)g=Math.max(g,q(a,b,c,d,e,f[h]));return g}function s(a,b,c,d,e,f){var g=0;return d._c&&(g=d._c/b),d._cl&&(g=Math.max(g,r(a,b,c,e,f,d._cl))),g}function t(a,b,c,d,e,f,g,h,i){var j={},k=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b));if(m(k))j.skip=!0;else{var l=Math.atan2(d-b,c-a),n=s(f,k,l,g,a,b),o=s(f,k,l+Math.PI,h,c,d),p=i.b1?i.b1:0,q=i.b2?i.b2:0;n=Math.max(p,n),o=Math.max(q,o);var r=.1;j.skip=n+o+r>1,j.skip||(j.cx1=a+n*(c-a),j.cy1=b+n*(d-b),j.cx2=c+o*(a-c),j.cy2=d+o*(b-d))}return j}function u(a,b){switch(a){case"x1":return h[b.id1].x;case"y1":return h[b.id1].y;case"x2":return h[b.id2].x;case"y2":return h[b.id2].y}}function v(a,b,c,d,e,f,g){var h=e-c;if(Math.abs(h)>d)return[];var i=Math.max(f,g),j=Math.min(f,g);if(i<b-d||b+d<j)return[];var k=Math.asin(h/d),l=d*Math.cos(k),m=[];return j<b-l&&b-l<i&&m.push(h>0?Math.PI-k:-Math.PI-k),j<b+l&&b+l<i&&m.push(k),m}function w(a,b,c,d,e,f,g){var h=e-b;if(Math.abs(h)>d)return[];var i=Math.max(f,g),j=Math.min(f,g);if(i<c-d||c+d<j)return[];var k=Math.acos(h/d),l=d*Math.sin(k),m=[];return j<c-l&&c-l<i&&m.push(-k),j<c+l&&c+l<i&&m.push(k),m}function x(a,b,c,d,e,f,g,h){var i=Math.PI/2,j=h?e:f;g._c&&(j+=(h?1:-1)*g._c/d);if(g._cl&&g._cl.length>0)for(var k=0;k<g._cl.length;k++){var l=g._cl[k],m=v(a,b,c,d,l.y2,l.x1,l.x2),n=v(a,b,c,d,l.y1,l.x1,l.x2),o=w(a,b,c,d,l.x1,l.y1,l.y2),p=w(a,b,c,d,l.x2,l.y1,l.y2),q=m.concat(n,p,o);for(var r=0;r<q.length;r++)q[r]+2*Math.PI<f&&(q[r]+=2*Math.PI),e<q[r]&&q[r]<f&&(h?q[r]-j<i&&(j=Math.max(j,q[r])):j-q[r]<i&&(j=Math.min(j,q[r])))}return j}function y(a,b,c,d,e,f,g,h,i){var j=x(a,c,d,e,f,g,b>0?h:i,!0),k=x(a,c,d,e,j,g,b>0?i:h,!1);return{startangle:j,endangle:k}}function z(a,b,c,d,e,f,g,i,j,k){var l=Math.floor((e+g)/2),m=Math.floor((f+i)/2),n=g-e,o=i-f,p=a.dim(c.off);p===0&&(p=c.off<0?-1:1);var q=Math.max(.001,o*o+n*n),r=Math.sqrt(q),s=(q/4+p*p)/(2*Math.abs(p)),t=s-Math.abs(p),u=p>0?1:-1,v=l-o*u*t/r,w=m+n*u*t/r,x=Math.atan2(f-w,e-v),z=Math.atan2(i-w,g-v),A=p>0?x:z,B=p>0?z:x;A>B&&(B+=Math.PI*2);var C=c.b1?c.b1:0,D=c.b2?c.b2:0,E=A+(p>0?C:D)*(B-A),G=A+(p>0?1-D:1-C)*(B-A),H=y(k,p,v,w,s,A,B,h[c.id1],h[c.id2]);H.startangle=Math.max(E,H.startangle),H.endangle=Math.min(G,H.endangle);if(H.startangle<H.endangle){var I=(H.startangle+H.endangle)/2,J={};J.lx=v+s*Math.cos(I),J.ly=w+s*Math.sin(I);var K,L,M,N=1.5*k/s;return c.a1&&(K=p>0?H.startangle:H.endangle,L=v+s*Math.cos(K),M=w+s*Math.sin(K),F(a,b,L,M,k,+u*N*.66+K-u*Math.PI/2,j,d+"#a1"),p>0?H.startangle+=N:H.endangle-=N),c.a2&&(K=p>0?H.endangle:H.startangle,L=v+s*Math.cos(K),M=w+s*Math.sin(K),F(a,b,L,M,k,-u*N*.66+K+Math.PI-u*Math.PI/2,j,d+"#a2"),p>0?H.endangle-=N:H.startangle+=N),H.startangle<H.endangle&&b.arc(v,w,s,H.startangle,H.endangle,j,k,d),J}return}function A(a,b,c,d,e,f,g,i,j,k){var l=t(e,f,g,i,a,k,h[c.id1],h[c.id2],c);if(l.skip)return;var m=l.cx1,n=l.cy1,o=l.cx2,p=l.cy2,q=o-m,r=p-n,s=Math.max(.001,r*r+q*q),u=Math.sqrt(s),v,w,x;c.a1&&(v=Math.atan2(r,q),F(a,b,m,n,k,v+Math.PI,j,d+"#a1"),m+=1.5*k*q/u,n+=1.5*k*r/u),c.a2&&(v=Math.atan2(r,q),F(a,b,o,p,k,v,j,d+"#a2"),o-=1.5*k*q/u,p-=1.5*k*r/u),b.line(m,n,o,p,j,k,d);var y={};return y.lx=(m+o)/2,y.ly=(n+p)/2,y}function B(a,b,c,d){if(a){var e=a.getNext();e.x=b,e.y=c,e.id=d}}function C(a,c,d,e,f,g,i){if(e.hi)return;var k=bR(f),m=c.x(h[e.id1].x),n=c.y(h[e.id1].y),o=c.x(h[e.id2].x),p=c.y(h[e.id2].y),q,r=c.w(e.w?e.w:1),s=e.c?e.c:b.colours.midgrey,t;e.off?t=z(c,d,e,f,m,n,o,p,s,r):t=A(c,d,e,f,m,n,o,p,s,r);var u=t?t.lx:(m+o)/2,v=t?t.ly:(n+p)/2;e._x=c.newToOldX(u),e._y=c.newToOldY(v);if(!t)B(g,u,v,f);else{var w=t.lx,x=t.ly,y=w,C=x,F=R(e),H=Number(e.fs?e.fs:j),I=c.dim(H),L=!1;if(J(e)){var M=e.fc?e.fc:b.colours.black,N=e.fbc?e.fbc:b.colours.textback;k&&(M=b.colours.white,N=bw());var O=(e.t+"").split(/\r\n|\r|\n/),P=c.dim(H+3),Q=0,S=[];for(q=0;q<O.length;q++){S[q]=b.measureText(a,O[q],I,e.fb,e.ff||l).width,Q=Math.max(Q,S[q]);if(q===0||q==="0")y-=S[0]/2}var T=x-Math.round((O.length-1)*P/2);for(var V=0;V<O.length;V++){if(q===0||q==="0")C=T;var W=K(a,c,d,O[V],w,T,I,f,!0,M,N,e.fb,e,!1,99,S[V],k,H,e.ff||l);L=L||W,T+=P}}var X=!J(e)||!L;X&&k&&d.circle(w,x,Math.floor(I/2),b.colours.white,-1,bw(),!0,f);if(F){y-=c.dim(D);var Y=c.dim(E);for(q=e.g.length-1;q>=0;q--)U(d,c,a,f+"#"+q,y,C,1,e.g[q],i),y-=Y}!F&&!J(e)&&B(g,w,x,f)}G(e,"id1",f,m,n,d,r,s),G(e,"id2",f,o,p,d,r,s)}function F(a,b,c,d,e,f,g,h){var i=e*1.7+a.dim(10),j=Math.PI/7;b.triangle(c+i*Math.cos(f+Math.PI+j),d+i*Math.sin(f+Math.PI+j),c+i*Math.cos(f+Math.PI-j),d+i*Math.sin(f+Math.PI-j),c,d,g,-1,g,!0,h)}function G(a,c,d,e,f,g,i,j){h[a[c]].du&&g.circle(e,f,Math.floor(i*1.5),j,i,b.colours.white,!0,d+"#"+c)}function I(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=b.measureText(a,e,h,m,s).width;return K(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,t,q,r,s)}function J(a){return a.hasOwnProperty("t")&&a.t}function K(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){if(d.length===0)return;var t=h+"#t";if(n&&p>o&&g>3)return I(a,b,c,d,e,f,Math.floor(g*.85),h,i,j,k,l,m,n,o,q,r,s);var u=b.dim(4),v=e-Math.round(p/2),w=f+Math.round(1+g/2),x={x1:v-u,y1:w-g,x2:v+p+u,y2:w};if(g>3)return i&&c.rect(x.x1,x.y1,x.x2,x.y2,k,-1,k,!0,t),m&&(m._edit=x,m._edit.fs=g,m._cl&&m._cl.push(x)),c.text(v,w,d,j,Math.round(g),l,t,s),!0;m&&(m._edit=null),x.y1-=1,x.y2-=1,x.y1===x.y2&&x.y2++;if(g===0){var y=b.dim(r*d.length*.2),z=Math.floor((x.x2+x.x1)/2);x.x2=z+y,x.x1=z-y}m&&m._cl&&m._cl.push(x);if(i&&q)c.rect(x.x1,x.y1,x.x2,x.y2,k,-1,k,!0,t);else{var A=M(j,.4);c.rect(x.x1,x.y1,x.x2,x.y2,A,-1,A,!0,t)}return!0}function M(a,c){var d=a+c;return L[d]||(L[d]=b.alphaize(a,c)),L[d]}function N(a){return a.w&&a.h}function Q(a,c,d,f,g,h,i,k){if(g.hi)return;if(g.du)return;var m,n,o=g.e?g.e:1,p=Math.floor(O*o),q=p,r=N(g),s=bR(h);r&&(p=Math.floor(g.w/2),q=Math.floor(g.h/2),o=1);var t=c.dim(p),u=c.dim(q),v=c.x(g.x),w=c.y(g.y);g._c=0,g._cl=[];var x=c.w(g.bw?g.bw:P),y=g.hasOwnProperty("c")&&g.c?!0:!1,z=g.hasOwnProperty("b")&&g.b?!0:!1,A=z?g.b:b.colours.white,B=z?Math.floor(x*o):-1,C=y?g.c:b.colours.white,F=S(g);(y||z)&&r&&(g.sh==="circle"?f.circle(v,w,Math.min(t,u),A,B,C,y,h):f.rect(v-t,w-u,v+t,w+u,A,B,C,y,h));if((z||y)&&!r){var G;g.sq?(G=c.dim(28*o),f.rect(v-G,w-G,v+G,w+G,A,B,C,y,h)):(G=c.dim(27*o),f.circle(v,w,G,A,B,C,y,h))}var H;if(F||z||y)if(r){var I={x1:v-t-x,y1:w-u-x,x2:v+t+x,y2:w+u+x};g.sh==="circle"?g._c=Math.min(t,u)+x+2:g._cl.push(I),s&&(g.re&&!F&&(bX=e.clone(f.getLast())),g.sh==="circle"?f.rect(v-Math.min(t,u)-x,w-Math.min(t,u)-x,v+Math.min(t,u)+x,w+Math.min(t,u)+x,bw(),x,bw(),!1,h):f.rect(I.x1,I.y1,I.x2,I.y2,bw(),x,bw(),!1,h),g.re&&(bY=f.getLast()))}else if(g.sq){H=c.dim(31*o);var L={x1:v-H,y1:w-H,x2:v+H,y2:w+H};g._cl.push(L),s&&f.rect(L.x1,L.y1,L.x2,L.y2,bw(),Math.floor(x*o),bw(),!1,h)}else H=c.dim(30*o),g._c=c.dim(32*o),s&&f.circle(v,w,H,bw(),Math.floor(x*o),bw(),!1,h);F&&(f.image(v-t,w-u,v+t,w+u,k+g.u,h,g.ci?"ci":undefined),s&&r&&g.re&&(bX=e.clone(f.getLast())));var M=v,Q=w,V=R(g),W;if(J(g)){var X=Math.floor((g.fs?g.fs:j)*o),Y=c.dim(5*o+X/2),Z=g.fc?g.fc:b.colours.black,$=g.fbc?g.fbc:b.colours.textback;s&&(Z=b.colours.white,$=bw());var _=(g.t+"").split(/\r\n|\r|\n/),ba=w+u+Y,bb=c.dim(X+3),bc=c.dim(X),bd=0,be=[];for(W=0;W<_.length;W++){be[W]=b.measureText(a,_[W],bc,g.fb,g.ff||l).width,bd=Math.max(bd,be[W]);if(W===0||W==="0")M-=be[0]/2}var bf=!1;r?g.tc&&(bf=!0):F||(bf=!0);if(bf)if(V){var bg=c.dim(D*o);M=v+bg,!y&&!z&&(v+=Math.floor(be[0]/2+bg)),ba=w,g._c=bg}else ba=w-Math.round((_.length-1)*bb/2);for(var bh=0;bh<_.length;bh++){if(W===0||W==="0")Q=ba;K(a,c,f,_[bh],v,ba,bc,h,!0,Z,$,g.fb,g,!1,99,be[bh],s,X,g.ff||l),ba+=bb}}if(V)if(F||z||y){var bi=Math.floor(4*o),bj=Math.floor((F?12:4)*o);if(g.g.length)for(W=0;W<g.g.length;W++){var bk=g.g[W];switch(bk.p){case"ne":T(f,c,a,h+"#ne",g.x+p-bi,g.y-q+bj,o,bk,k);break;case"nw":T(f,c,a,h+"#nw",g.x-p+bi,g.y-q+bj,o,bk,k);break;case"sw":T(f,c,a,h+"#sw",g.x-p+bi,g.y+q-bj,o,bk,k);break;case"se":T(f,c,a,h+"#se",g.x+p-bi,g.y+q-bj,o,bk,k)}}}else{M-=c.dim(D*o);var bl=c.dim(E*o);for(W=g.g.length-1;W>=0;W--)U(f,c,a,h+"#"+W,M,Q,o,g.g[W],k),M-=bl}}function R(a){return a.hasOwnProperty("g")&&e.isArray(a.g)&&a.g.length>0}function S(a){return a.hasOwnProperty("u")&&a.u}function T(a,b,c,d,e,f,g,h,i){var j=b.x(e),k=b.y(f);U(a,b,c,d,j,k,g,h,i)}function U(a,c,d,e,f,g,h,i,j){if(i){var m=i.a?bJ:1,n=c.dim(9*h*m);if(i.c){a.circle(f,g,n,b.colours.keyline,c.w(2*h),i.c,!0,e);if(i.t){var o=(i.t+"").substring(0,3),p=h*k[o.length-1];I(d,c,a,o,f,g,c.dim(h*k[o.length-1]),e,!1,b.colours.white,b.colours.white,!0,null,!0,n*1.7,!1,p,i.ff||l)}else if(i.u){var q=Math.floor(n/1.414);a.image(f-q,g-q,f+q,g+q,j+i.u,e)}}else i.u&&a.image(f-n,g-n,f+n,g+n,j+i.u,e);bK=bK||i.a}}function W(a){a.type==="node"&&(a.x||(a.x=0),a.y||(a.y=0))}function X(a,b){var c={},d={};if(a)for(var f=0;f<a.length;f++){var g=a[f];if(g.id&&!(g.id in c)&&!(g.id in d)){var i=null;if(g.type==="node"){i=c;var j=!0;b&&h[g.id]&&(j=!1),j&&W(g)}g.type==="link"&&(i=d),i&&(i[g.id]=e.clone(g))}}return{nodes:c,links:d}}function Y(){var a,b,c=[];for(a in i)b=e.clone(i[a],!0),b.id=e.ensureId(a),c.push(b);for(a in h)b=e.clone(h[a],!0),b.id=e.ensureId(a),c.push(b);return c}function Z(a){$(a.items)}function $(a){if(a)for(var b=0;b<a.length;b++)_(a[b])}function _(a){be(a),a.g&&(e.isArray(a.g)?be(a.g):delete a.g)}function ba(a){var b=[];for(var c in a)(typeof a[c]=="undefined"||a[c]===null)&&b.push(c);for(c in b)delete a[b[c]]}function be(a){var b,c;if(a){for(c=0;c<bb.length;c++)b=bb[c],a[b]&&(a[b]=Number(a[b]));for(c=0;c<bc.length;c++)b=bc[c],a[b]&&(a[b]=a[b]+"")}}function bf(a){var b={};for(var c in a)a[c].id1!==a[c].id2&&(b[c]=a[c]);return b}function bg(a,b){var c={};for(var d in a)bh(a[d],b)&&(c[d]=a[d]);return c}function bh(a,b){return b=b||{},(h[a.id1]||b[a.id1])&&(h[a.id2]||b[a.id2])}function bi(a,b){for(var c in i){var d=i[c];if(h[d.id1][a]===b||h[d.id2][a]===b)i[c][a]=b}}function bj(a,b){a[b]&&bP(a.id,!0)}function bk(a){for(var b in i)bj(i[b],a);for(b in h)bj(h[b],a)}function bl(){bm("hi")}function bm(a){bi(a,!0),bk(a)}function bn(a,b,c){for(var d=0;d<a.length;d++)h[a[d]]&&(h[a[d]][b]=c),i[a[d]]&&(i[a[d]][b]=c)}function bo(a,b){var c=!1;return h[a]&&(c=bq(h[a],b)),i[a]&&(c=bq(i[a],b)),c}function bp(a){return!bo(a,"hi")&&!bo(a,"gh")}function bq(a,b){return a[b]?!0:!1}function br(a,b,c){a=e.ensureArray(a),bn(a,b,!1),bm(b);if(c){var d={};for(var f in a)d[a[f]]=1;for(f in i)bq(i[f],b)&&!bq(h[i[f].id1],b)&&!bq(h[i[f].id2],b)&&(d[i[f].id1]||d[i[f].id2])&&(i[f][b]=!1)}}function bs(a){var b=[];for(var c in h)c=e.ensureId(c),h[c][a]&&b.push(c);for(c in i)c=e.ensureId(c),i[c][a]&&b.push(c);return b}function bt(a,b){a=e.ensureArray(a),bn(a,b,!0),bm(b)}function bA(a){var b={};for(var c in a)typeof a[c].off=="undefined"&&(b[c]=a[c]);return b}function bF(){var a=!1,b,c,d,e;for(var f in h){b=h[f],b.u&&(b.u in bD||(bD[b.u]=1,a=!0));if(R(b))for(e=0;e<b.g.length;e++)d=b.g[e],d&&d.u&&(bD[d.u]=1,a=!0)}for(var g in i){c=i[g];if(R(c))for(e=0;e<c.g.length;e++)d=c.g[e],d&&d.u&&(bD[d.u]=1,a=!0)}return a}function bH(a){return a.gh?N(a)?b.layers.GHOSTSHAPES:b.layers.GHOSTNODES:N(a)?b.layers.SHAPES:b.layers.NODES}function bI(a){return a.gh?b.layers.GHOSTLINKS:b.layers.LINKS}function bT(a){for(var b in a)bO(b,!0)}function b_(a){return(a+"").match(bZ)}function ca(a){var b=b_(a);return b$[b[2]]}function cb(a){var b=b_(a);return b?b[1]:null}var e=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,f=typeof KeyLinesRequire!="undefined"?require("./layouts"):KeyLines.Layouts,g={},h={},i={};g.graph=c.create(g,a),g.graph.privateSetProperties(h,i);var j=14,k=[12,9,7],l;g.fontFamily=function(a){return a&&(l=a),l};var D=13,E=21,H=g.labelPosition=function(a,b){var c=bC(a),d=c._edit;if(d){var e=["x1","x2","y1","y2","fs"];for(var f=0;f<e.length;f++)d[e[f]]=b.unscale(d[e[f]])}return c?c.hi?null:c._edit:null},L={},O=26,P=4;g.nodeTextWidth=function(a,c){var d=0,e=0;if(J(a)){var f=Math.floor((a.fs?a.fs:j)*(a.e?a.e:1)),g=(a.t+"").split(/\r\n|\r|\n/);for(var h=0;h<g.length;h++)d=Math.max(d,b.measureText(c,g[h],f,a.fb,a.ff||l).width);e=f*(g.length+1),S(a)||(d/=10)}return{width:d,height:e}};var V=g.load=function(a){if(a){h={},i={},Z(a);var b=X(a.items);h=b.nodes,i=bg(b.links),i=bf(i),bl(),f.setUpUninitializedConnections(i),g.graph.privateSetProperties(h,i)}bF()};g.defaultValueFor=function(a){switch(a){case"e":return 1;case"fs":return j;case"off":return 0;case"x":case"y":return 0;case"w":case"h":return 1;case"c":case"b":return b.colours.midgrey;case"fc":return b.colours.black;case"fbc":return b.colours.textback}};var bb=["x","y","w","h","e","fs","off"],bc=["t","u","id","id1","id2"],bd=["c","b","fc","fbc"];g.resurrect=function(a,b){br(a,"gh",b)},g.ghosted=function(){return bs("gh")},g.ghost=function(a){bt(a,"gh")},g.show=function(a,b){br(a,"hi",b)},g.hidden=function(){return bs("hi")},g.hide=function(a){bt(a,"hi")},g.each=function(a,b){if(a.type.match(/^(node|all)$/))for(var c in h)b(h[c]);if(a.type.match(/^(link|all)$/))for(var d in i)b(i[d])},g.setItem=function(a){_(a);var b=null;a.type==="node"&&(b=h);if(a.type==="link"){b=i;if(!bh(a))return!1}return W(a),a.id&&(b[a.id]=e.clone(a),a.hi&&bl()),bF()};var bu=g.type=function(){return"LinkChart"},bv,bw=g.editColour=function(a){return a&&(bv=a),bv||b.colours.edit},bx=g.serialize=function(a){return{type:bu(),items:Y()}},by=g.applyChanges=function(a,b){var c,d,f,g,j,k,l;for(c=0;c<a.length;c++){d=e.rawId(a[c].id);if(d){k=[];if(b){l=new RegExp(d,"im");for(f in h)l.test(f)&&k.push(h[f]);for(g in i)l.test(g)&&k.push(i[g])}else h[d]&&k.push(h[d]),i[d]&&k.push(i[d])}var m=e.clone(a[c]);delete m.id,delete m.type;for(j=0;j<k.length;j++)k[j]=e.merge(k[j],m),ba(k[j])}},bz=g.setProperties=function(a,b){a=e.ensureArray(a),$(a),by(a,b),bl();var c=bF();return c},bB=g.merge=function(a,b){b=b||{},$(a);var c=X(a,!0);c.links=bg(c.links,c.nodes),c.links=bf(c.links);for(var d in c.nodes)h[d]=e.merge(h[d],c.nodes[d]);for(var g in c.links)i[g]=e.merge(i[g],c.links[g]);if(!b.preserveOffsets){var j=bA(c.links);f.resetConnectionOffsets(i,j)}bl();var k=bF();return k};g.getItem=function(a){var b=bC(a);return e.clone(b,!0)};var bC=g.getByID=function(a){return a=e.rawId(a),h[a]?h[a]:i[a]};g.isNode=function(a){return a=e.rawId(a),h[a]?!0:!1},g.randomWalker=function(){var a=!0,b={};return{animate:function(c){var d;if(a){var e=.05;for(d in h)b[d]={vx:(Math.random()-.5)*e,vy:(Math.random()-.5)*e};a=!1}else for(d in h){h[d].x+=c*b[d].vx,h[d].y+=c*b[d].vy;if(h[d].x<0||h[d].x>842)b[d].vx=-b[d].vx;if(h[d].y<0||h[d].y>596)b[d].vy=-b[d].vy}return!0}}};var bD={},bE=g.imageList=function(a){var b={};for(var c in bD)b[a+c]=1;return b},bG=g.generate=function(c,d,e,f,g,j,k){var l,m,n,o;bJ=a.atanEasing((new Date).getTime()%1e3/1e3),bK=!1,bX=null,bY=null,g&&g.reset();for(l in h)m=h[l],o=bH(m),c.layer(o),(!j||j(m))&&Q(d,e,f[m.u],c,m,l,g,k);for(l in i)n=i[l],o=bI(n),c.layer(o),(!j||j(n))&&C(d,e,c,n,l,g,k);c.layer(b.layers.HANDLES),bY&&bM.length===1&&b.getHandles(c,d,bY,1,bY.id,bw())};g.generateSelection=function(a,b,c,d,e,f){bG(a,b,c,d,e,function(a){return a.id in bL},f)};var bJ,bK;g.animated=function(){return bK};var bL={},bM=[],bN=g.setSelection=function(a,b,c){a=e.rawId(a),!b&&!c&&bS(a),bL[a]?b&&bP(a):bO(a)},bO=g.addToSelection=function(b,c){b=e.rawId(b),b&&(bL[b]||bp(b)&&(bL[b]=1,bM.push(b),c||a.trigger("selectionchange")))},bP=g.removeFromSelection=function(b,c){b=e.rawId(b);if(bL[b]){delete bL[b];var d=e.indexOf(bM,b);d>-1&&bM.splice(d,1),c||a.trigger("selectionchange")}},bQ=g.hasSelection=function(){return bM.length>0},bR=g.isSelected=function(a){return a=e.rawId(a),a in bL},bS=g.clearSelection=function(b){bL={},bM=[],b||a.trigger("selectionchange")};g.selectAll=function(){bT(h),bT(i),a.trigger("selectionchange")};var bU=g.doSelection=function(a){if(a){bS(!0);for(var b=0;b<a.length;b++)bO(a[b],!0)}return e.clone(bM)};g.moveSelection=function(a,b){var c=[];if(bL){for(var d in h)bR(d)&&c.push(d);for(var e in i)bR(e)&&(h[i[e].id1].du&&c.push(i[e].id1),h[i[e].id2].du&&c.push(i[e].id2))}for(var f=0;f<c.length;f++){var g=h[c[f]];g.x+=a,g.y+=b}};var bV=g.removeItem=function(a,b){b=b||{};var c;a=e.ensureArray(a);var d={},g={};for(var j=0;j<a.length;j++)c=a[j],i[c]&&(d[c]=i[c]),h[c]&&(g[c]=1);for(c in i)if(g[i[c].id1]||g[i[c].id2])d[c]=i[c];for(c in d)bP(c,!0),delete i[c];for(c in g)bP(c,!0),delete h[c];b.preserveOffsets||f.resetConnectionOffsets(i,d)};g.selectionPlusDummyNodes=function(){var a=bU();for(var b=0;b<a.length;b++){var c=i[a[b]];c&&(h[c.id1].du&&a.push(c.id1),h[c.id2].du&&a.push(c.id2))}return a},g.contains=function(a){function g(a,b){a&&f.push(b)}var c,d,f=[];a=e.defaults(a,{sh:"box",x:0,y:0});if(N(a))if(a.sh==="circle"){var i=Math.min(a.w,a.h)/2;for(d in h)c=h[d],N(c)?c.sh==="circle"?g(b.insideCircle(a.x,a.y,i,c.x,c.y,Math.min(c.w,c.h)/2),c.id):g(b.circleContains(a.x,a.y,i,c.x-c.w/2,c.y-c.h/2,c.x+c.w/2,c.y+c.h/2),c.id):g(b.insideCircle(a.x,a.y,i,c.x,c.y),c.id)}else{var j={x1:a.x-a.w/2,y1:a.y-a.h/2,x2:a.x+a.w/2,y2:a.y+a.h/2};for(d in h){c=h[d];if(N(c))if(c.sh==="circle"){var k=Math.min(c.w,c.h)/2;g(b.rectContains(j,c.x-k,c.y-k,c.x+k,c.y+k),c.id)}else g(b.rectContains(j,c.x-c.w/2,c.y-c.h/2,c.x+c.w/2,c.y+c.h/2),c.id);else g(b.inside(j,c.x,c.y),c.id)}}return f};var bW=g.getCursor=function(a,b){var c=cb(a);return c?c:a?'url("'+b+'openhand.cur"), pointer':"auto"},bX=null,bY=null;g.getResizePrimitive=function(){return bX};var bZ=/#((\S+)(?:\-resize))$/,b$={nw:["x1","y1"],n:["y1"],ne:["x2","y1"],e:["x2"],se:["x2","y2"],s:["y2"],sw:["x1","y2"],w:["x1"]},cc=g.startDragger=function(a,b,c,f,j,k,l){var m=(l+"").match(/#(id[1|2])$/),n=e.rawId(f);return d.createLinkEndDragger(a,g,c,h,i[n],m[1],j,k,n)},cd=g.createDragger=function(c,f,j,k,l,m,n,o,p,q,r,s){var t=p.handMode,v=e.rawId(m),w=b_(m);if(w){var x=ca(m),y=s;return d.primitiveMover(b,k,l,v,y,!0,x,n,o,function(b){a.trigger("prechange","resize");var c=h[e.rawId(m)];if(b.p==="C")c.x=l.newToOldX(b.x),c.y=l.newToOldY(b.y),c.w=c.h=2*l.undim(b.r);else{var d=l.newToOldX(b.x1),f=l.newToOldY(b.y1),g=l.newToOldX(b.x2),i=l.newToOldY(b.y2);c.x=d+Math.floor((g-d)/2),c.y=f+Math.floor((i-f)/2),c.w=g-d,c.h=i-f}})}if(v!==null&&i[v]){var z=(m+"").match(/#(id[1|2])$/);return z?d.createLinkEndDragger(j,g,l,h,i[v],z[1],n,o,v):d.createLinkDragger(u,k,l,i[v],n,o,v)}return t||v!==null?d.createDefaultDragger(h,bR,k,l,m,n,o):cf(c,f,k,l,v,n,o,q,r,p.crossingBox)},ce=[["x1","y1"],["y1"],["x2","y1"],["x2"],["x2","y2"],["y2"],["x1","y2"],["x1"]],cf=function(c,d,f,g,j,k,l,m,n,o){function u(a,b){t.x1=Math.min(r,a),t.y1=Math.min(s,b),t.x2=Math.max(r,a),t.y2=Math.max(s,b)}function v(a,c,d,e){u(a,c);var f={};f.x1=g.newToOldX(t.x1),f.y1=g.newToOldY(t.y1),f.x2=g.newToOldX(t.x2),f.y2=g.newToOldY(t.y2);var j={};for(var k in h)j[k]=b.inside(f,h[k].x,h[k].y);for(var l in i)j[l]=b.inside(f,i[l]._x,i[l]._y);for(var m in j)j[m]?bO(m):d||e?p[m]||bP(m):bP(m)}function w(a,g,h,i){u(a,g);if(c){var j={},k;c.each(function(a){if(a.p!==b.primitives.line&&a.p!==b.primitives.arc&&a.p!==""){var c=b.extents(f,a);k=e.rawId(a.id),j[k]=j[k]||b.intersects(t,c)}}),d.each(function(a){k=e.rawId(a.id),j[k]=j[k]||b.inside(t,a.x,a.y)});for(var l in j)j[l]?bO(l):h||i?p[l]||bP(l):bP(l)}}if(a.trigger("dragstart","area",null,g.unscale(k),g.unscale(l),null))return;var p={};for(var q in bL)p[q]=1;var r=k,s=l,t={p:b.primitives.rect,x1:r,y1:s,x2:r,y2:s,bc:b.colours.midgrey,bw:1,fc:b.colours.blue,fi:!1},x={scrollable:!0,getCursor:function(a,b){return"crosshair"},generate:function(a){a.copyPrimitive(t)},dragMove:function(a,b,c,d){a>k||!o?v(a,b,c,d):w(a,b,c,d)},endDrag:function(b,c,d,e,f){g.cancelScroll();var h=a.trigger("dragend","area",null,g.unscale(c),g.unscale(d));h||b||bS(),a.trigger("dragcomplete","area",null,g.unscale(c),g.unscale(d))}};return x};return g.createGestureDragger=function(b,c,d){function k(a,c,d){var e=-a*2*Math.PI/360;e*=2;var j=Math.sin(e),k=Math.cos(e);for(var l in h)h[l].x=(i[l].x-f)*k+(i[l].y-g)*j+f,h[l].y=-(i[l].x-f)*j+(i[l].y-g)*k+g;var m=b.newToOldX(c),n=b.newToOldY(d);for(var o in h)h[o].x+=m-f,h[o].y+=n-g}function l(a){a=Math.pow(a,2),b.zoomToPosition(a*e,c,d)}function q(a,b,c,d){m=a,n=b,o=c,p=d}function u(){l(m),r=r||Math.abs(n)>12,t=t||Math.abs(o-f)>s||Math.abs(p-g)>s,k(r?n:0,t?o:f,t?p:g)}function v(){for(var a in h)h[a].x=i[a].x,h[a].y=i[a].y}var e=b.zoom(),f=b.newToOldX(c),g=b.newToOldY(d),i={};for(var j in h)i[j]={x:h[j].x,y:h[j].y};var m,n,o,p;q(1,0,f,g);var r=!1,s=60,t=!1,w={animate:function(a){u()},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){q(a,b,c,d)},endDrag:function(b,c,d,e,f){q(c,d,e,f),b?(v(),a.trigger("prechange","move"),u()):v()}};return w},g.extractStructure=function(a,b,c){return f.extractStructure(g,a,h,i,b,c)},g.layout=function(a,b,c,d,e,g){f.layout(a,b,c,d,e,g)},g.applyVertices=function(a){for(var b in h)a[b]&&(h[b].x=a[b].x,h[b].y=a[b].y)},g.makeAnimator=function(b,c){var d=c,e={};for(var f in h)e[f]={x:h[f].x,y:h[f].y};return{animate:function(f){d-=f;var g=a.cubicEasing(Math.max(0,(c-d)/c));for(var i in h)b[i]&&(h[i].x=e[i].x+g*(b[i].x-e[i].x),h[i].y=e[i].y+g*(b[i].y-e[i].y));return d>0}}},g}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.API={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=typeof KeyLinesRequire!="undefined"?require("./view"):this.KeyLines.View,d=typeof KeyLinesRequire!="undefined"?require("./events"):this.KeyLines.Events,e=typeof KeyLinesRequire!="undefined"?require("./model"):this.KeyLines.Model,f=typeof KeyLinesRequire!="undefined"?require("./timemodel"):this.KeyLines.TimeModel,g=typeof KeyLinesRequire!="undefined"?require("./controller"):this.KeyLines.Controller,h=typeof KeyLinesRequire!="undefined"?require("./overlays"):this.KeyLines.Overlays,i=typeof KeyLinesRequire!="undefined"?require("./draggers"):this.KeyLines.Draggers;a.createAPI=function(){function r(a,b){return function(){if(q){var c=(new Date).getTime(),d=a.apply(this,arguments),e=(new Date).getTime();return console.log("fn "+b+" = "+(e-c)+"ms"),d}return a.apply(this,arguments)}}function v(b,c){b?p.afterChange(c):(p.render(),a.invoke(c))}function w(b){return b===!0&&(b={animate:!0}),a.defaults(b,{animate:!1,time:1e3})}var a=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,j={},k=d.createEventBus(),l,m=i.createDraggers(k),n=e.createModel(k,m),o=h.createOverlays(k,c),p=g.createController(j,k,o);p.setModel(n);var q=!0,s;j.privateEventBus=function(){return k};var t=j.privateInit=function(a,b,c,d,e,f,g,h,i,j){s=e,p.assetPath(h),p.setCursorFn(f),p.setCreateCanvasFn(e),p.setImageGenFn(g),u(a,b,c,d,i),p.imageBasePath(j)},u=j.privateSetSize=function(a,d,e,f,g,h){p.makeGhostCanvas(e,f),g&&(e/=g,f/=g),l=c.createView(k,e,f,g),p.setView(l),p.setCanvas(a),p.setShadowCanvas(d.getContext("2d")),b.clearLastFont(),p.afterChange(null,h)};j.privateViewSettings=function(){return l.settings()},j.privateViewFromOldSettings=function(a,b){l.fromOldSettings(a,b)},j.privateFlashClick=function(a){k.trigger("flashclick",a)},j.privateGetMethodsWithCallbacks=function(){return["animateProperties","contains","directLayout","displayOptions","finishLayout","hide","load","merge","pan","setItem","setProperties","show","viewOptions","zoom"]},j.privateNamespaceNames=function(a){var b=[],c=j[a]();for(var d in c)d.indexOf("private")===-1&&b.push(d);return b},j.graph=function(){return n.graph},j.combo=function(){return p.combo.api},j.layoutStructure=function(a,b){return p.extractStructure(a,b)},j.finishLayout=function(a,b,c){p.finishLayout(a,b,!1,c)},j.toDataURL=function(b,d,e){function t(a){b=Math.floor(b/a),d=Math.floor(d/a)}b=Math.floor(b),d=Math.floor(d),e=a.defaults(e,{fit:"view",watermark:!0,gradient:!0,logo:!0});var f;if(e.fit==="oneToOne"){var i=p.modelExtents();i||(i={x1:0,y1:0,x2:100,y2:100});var m=10;f={x1:l.newToOldX(i.x1)-m,x2:l.newToOldX(i.x2)+m,y1:l.newToOldY(i.y1)-m,y2:l.newToOldY(i.y2)+m};var o=p.watermarkSize();if(o&&e.watermark){var q=(o.width-(f.x2-f.x1))/2;q>0&&(f.x1-=q,f.x2+=q);var r=(o.height-(f.y2-f.y1))/2;r>0&&(f.y1-=r,f.y2+=r)}b=f.x2-f.x1,d=f.y2-f.y1,e.noScale=!0}var u=16e6,v=b*d,w=v/u;if(w>1){var x=Math.sqrt(w);t(x)}var y=8e3,z=b/y;z>1&&t(z);var A=d/y;A>1&&t(A);var B=s(b,d),C=B.getContext("2d"),D=e.noScale?1:b/l.width(),E=c.createView(k,Math.floor(b/D),Math.floor(d/D)),F=h.createOverlays(k,c),G=g.createController(j,k,F);G.setCreateCanvasFn(s),G.setModel(n),G.setView(E),G.setCanvas(C),G.assetPath(p.assetPath()),G.imageBasePath(p.imageBasePath()),G.imageList(p.imageList());var H=p.displayOptions();e.watermark||(H.watermark=!1),e.gradient||(H.gradient=!1),e.logo||(H.logo=!1),G.displayOptions(H,null,!0),G.makeGhostCanvas(E.width(),E.height());var I=[];e.selection||(I=n.doSelection(),n.doSelection([]));switch(e.fit){case"chart":G.fitToModel(!1);break;case"view":E.fromOldSettings(l.settings(),!0);break;case"exact":E.fromOldSettings(l.settings(),!1);break;case"oneToOne":E.fitWorldExtents(f,!1,!1,!1,0,0)}E.scaleFactor(D),G.draw(!0);var J=B.toDataURL();return e.selection||n.doSelection(I),J},j.load=function(a,b){switch(a.type){case"LinkChart":n=e.createModel(k,m),p.setModel(n),p.load(a),p.afterChange(b);break;case"Timeline":n=f.createModel(k,m),p.setModel(n),p.load(a),p.afterChange(b);break;default:throw new Error("Unknown chart type passed to load")}},j.chartType=function(){return n.type()},j.clear=function(){k.trigger("prechange","delete"),n.load({items:[]}),p.combo.internalUse.loadUp(),p.afterChange(null,!0)},j.startDragger=function(a,b,c,d){p.startDragger(a,b,c,d)},j.merge=function(a,b){var c=p.merge(a);p.postMerge(function(){v(c,b)})},j.privateMerge=function(a,b){var c=n.merge(a);v(c,b)},j.privateEach=function(a,b){n.each(a,b)},j.setProperties=function(a,b,c){var d=p.setProperties(a,b);v(d,c)},j.animateProperties=function(b,c,d){c=a.defaults(c,{time:1e3,easing:"linear"}),b=a.ensureArray(b),p.animateProperties(b,c,d)},j.getItem=function(b){if(a.isArray(b)){var c=[];for(var d=0;d<b.length;d++){var e=n.getItem(b[d]);e=e||null,c.push(e)}return c}return n?n.getItem(b):null},j.setItem=function(a,b){if(a){k.trigger("prechange","properties");var c=n.setItem(a);v(c,b)}},j.removeItem=function(a){k.trigger("prechange","delete"),p.removeItem(a),p.render()},j.privateRemoveItem=function(a){n.removeItem(a),p.render()},j.hide=function(b,c,d){k.trigger("prechange","hide"),b=a.ensureArray(b),c=w(c),c.animate?p.hide(b,c.time,function(){n.hide(b),a.invoke(d)}):(n.hide(b),p.render(),a.invoke(d))},j.hidden=function(){return n.hidden()},j.show=function(b,c,d,e){k.trigger("prechange","show"),b=a.ensureArray(b),n.show(b,c),d=w(d),d.animate?p.show(b,!0,d.time,e):(p.render(),a.invoke(e))},j.labelPosition=function(a){return n?n.labelPosition(a,l):null},j.contains=function(a){return n?n.contains(a):[]},j.serialize=function(){var a=n.serialize(l);return p.appendCombos(a),a.displayOptions=p.displayOptions(),a.viewSettings=l.settings(),a},j.worldCoordinates=function(a,b){var c=l.scale(a),d=l.scale(b);return{x:l.newToOldX(c),y:l.newToOldY(d)}},j.viewCoordinates=function(a,b){var c=l.oldToNewX(a),d=l.oldToNewY(b);return{x:l.unscale(c),y:l.unscale(d)}},j.viewOptions=function(b,c,d){if(!b)return l.settings();var e=w(c);b=a.defaults(b,{offsetX:0,offsetY:0,zoom:1}),p.setViewSettings(b,e.animate,e.time,d)},j.displayOptions=function(a,b){return p.displayOptions(a,b)},j.interactionOptions=function(a){return p.interactionOptions(a)},j.lock=function(a,b){return typeof a!="undefined"&&(x=a,a?(b=b||{},p.wait(b.wait)):p.wait(!1),p.render()),x};var x=!1;j.zoom=function(a,b,c){var d=w(b);switch(a){case"in":p.zoomIn(d.animate,d.time,c);break;case"out":p.zoomOut(d.animate,d.time,c);break;case"one":p.setZoom(1,d.animate,d.time,c);break;case"fit":p.fitToModel(d.animate,d.time,c);break;case"selection":p.fitToSelection(d.animate,d.time,c)}},j.pan=function(a,b,c){var d=w(b);switch(a){case"up":p.panUp(d.animate,d.time,c);break;case"down":p.panDown(d.animate,d.time,c);break;case"left":p.panLeft(d.animate,d.time,c);break;case"right":p.panRight(d.animate,d.time,c)}},j.getLastError=function(){return k.getErrors()},j.ping=function(a,b){p.ping(a,b)},j.imagePrefix=function(a){return p.imagePrefix(a)},j.measureText=function(a,b,c,d){return p.measureText(a,b,c,d).width},j.requestRedraw=function(){p.render()},j.draw=function(a){p.draw(a)},j.drawShadow=function(){p.drawoffscreen(),p.afterDraw()},j.animate=function(a){return p.animate(a)},j.modelAnimated=function(){return n?n.animated():!1},j.randomWalk=function(){n&&n.randomWalker&&p.pushAnimation(n.randomWalker())},j.cancelAnimation=function(){p.cancelAnimation()},j.directLayout=function(a,b,c){p.layout(a,b,!1,c)},j.selection=function(a){var b=n?n.doSelection(a):[];return p.render(),b},j.mousedown=function(a,b,c,d,e){if(x)return;p.mousedown(a,b,c,d,e)},j.mousemove=function(a,b,c,d){p.mousemove(a,b,c,d,x)},j.mouseup=function(a,b,c,d){if(x)return;p.mouseup(a,b,c,d)},j.mouseleave=function(a){if(x)return;p.mouseleave()},j.mousewheel=function(a,b,c){if(x)return;p.mousewheel(a,b,c)},j.dblclick=function(a,b,c,d){if(x)return;p.dblclick(a,b,c,d)},j.touchstart=function(a,b){if(x)return;p.touchstart(a,b)},j.touchmove=function(a,b){if(x)return;p.touchmove(a,b)},j.touchend=function(a,b){if(x)return;p.touchend(a,b)},j.touchcancel=function(a,b){if(x)return;p.touchcancel(a,b)},j.gesturestart=function(){if(x)return;p.gesturestart()},j.gesturechange=function(a,b){if(x)return;p.gesturechange(a,b)},j.gestureend=function(a,b){if(x)return;p.gestureend(a,b)},j.keyup=function(a){if(x)return;p.keyup(a)},j.keydown=function(a,b,c){if(x)return;return p.keydown(a,b,c)};for(var y in k)j[y]=k[y];return j}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Canvas={});var b=typeof KeyLinesRequire!="undefined"?require("./api"):this.KeyLines.API;a.create=function(a,c,d,e,f){function g(a,b){var c=document.createElement("canvas");return c.height=b,c.width=a,c}function h(){return new Image}function v(){l.ready&&l.drawShadow(),t&&clearTimeout(t),t=undefined}function w(){t=setTimeout(v,350)}function x(){var a=(new Date).getTime(),b=a>>10;b>q?(s=Math.round(r/(b>q)),r=0,q=b):r++;if(l.ready){var c=l.animate(a-p);p=a,u|=c,u&&(u=!1,l.draw(),l.drawShadow())}window.requestAnimFrame(x)}var i=g(c,d),j=document.getElementById(a);j.parentNode.replaceChild(i,j),i.setAttribute("id",a);var k=document.getElementById(a),l={},m=b.createAPI();for(var n in m)n.indexOf("private")===-1&&(l[n]=m[n]);var o=g(c,d);m.privateInit(k.getContext("2d"),o,c,d,g,function(b){document.getElementById(a).style.cursor=b},h,e,undefined,f),l.setSize=function(a,b,c){var d=m.privateViewSettings();o=g(a,b),k.width=a,k.height=b,m.privateSetSize(k.getContext("2d"),o,a,b,c,!0),m.privateViewFromOldSettings(d,!1)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var p=(new Date).getTime(),q=p>>10,r=0,s=0,t,u=!1;return l.frameRate=function(){return s},l.bind("redraw",function(){u=!0}),l.canvas=!0,l.ready=!0,window.requestAnimFrame(x),l}})();

